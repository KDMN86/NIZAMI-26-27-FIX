<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kalender Setoran - Nizami</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* === SETUP DASAR === */
      * {
        box-sizing: border-box;
      }
      body {
        background-color: #071a10;
        color: #fff;
        font-family: "Poppins", sans-serif;
        margin: 0;
        padding-bottom: 50px;
      }

      header {
        padding: 20px;
        text-align: center;
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(7, 26, 16, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #113320;
      }
      .title {
        color: #ffd700;
        margin: 0;
        font-size: 1.4rem;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
      }

      .container {
        padding: 15px 20px;
        max-width: 600px;
        margin: 0 auto;
      }

      /* === HEADER INFO PESERTA === */
      .info-card {
        background: #111;
        border-radius: 16px;
        padding: 20px;
        text-align: center;
        border: 1px solid #222;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        margin-bottom: 20px;
      }
      .badge-paket {
        display: inline-block;
        background: #007bff;
        color: #fff;
        padding: 4px 15px;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: bold;
        margin-bottom: 10px;
      }
      .info-name {
        font-size: 1.4rem;
        font-weight: 800;
        margin: 0 0 5px 0;
        text-transform: uppercase;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 15px;
        margin-top: 15px;
        border-top: 1px solid #222;
        padding-top: 15px;
      }
      .stat-box {
        display: flex;
        flex-direction: column;
      }
      .stat-val {
        font-size: 1.5rem;
        font-weight: 800;
        line-height: 1;
      }
      .stat-val.green {
        color: #4ade80;
      }
      .stat-val.gold {
        color: #ffd700;
      }
      .stat-label {
        font-size: 0.65rem;
        color: #888;
        margin-top: 5px;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      /* Rincian Target (Barang & Uang) */
      .target-detail-box {
        background: #0a0a0a;
        border: 1px dashed #333;
        border-radius: 10px;
        padding: 10px;
        margin-top: 15px;
        display: flex;
        justify-content: space-around;
        font-size: 0.75rem;
      }
      .td-item i {
        margin-right: 5px;
      }

      .btn-back {
        width: 100%;
        padding: 12px;
        background: #222;
        color: #fff;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        margin-top: 15px;
        cursor: pointer;
        transition: 0.2s;
      }
      .btn-back:active {
        background: #333;
      }

      /* === LEGEND WARNA KALENDER === */
      .legend-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 0.7rem;
        color: #aaa;
      }
      .lg-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .lg-box {
        width: 14px;
        height: 14px;
        border-radius: 3px;
      }
      .lg-b-done {
        background: #4ade80;
      }
      .lg-u-done {
        background: #ffd700;
      }
      .lg-b-pend {
        border: 1px solid #4ade80;
      }
      .lg-u-pend {
        border: 1px solid #ffd700;
      }

      /* === CALENDAR GRID === */
      .month-card {
        background: #111;
        border-radius: 16px;
        padding: 15px;
        border: 1px solid #222;
        margin-bottom: 20px;
      }
      .month-title {
        text-align: center;
        color: #48dbfb;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1rem;
        letter-spacing: 1px;
        text-transform: uppercase;
      }

      /* Grid Harian */
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
      .cal-head {
        text-align: center;
        font-size: 0.7rem;
        color: #888;
        font-weight: 600;
        padding-bottom: 8px;
      }
      .cal-cell {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: bold;
        border-radius: 6px;
      }
      .cal-cell.empty {
        background: transparent;
      }

      /* Grid Mingguan Khusus */
      .cal-grid-weekly {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .weekly-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 5px;
        border-radius: 8px;
        text-align: center;
      }
      .w-tgl {
        font-size: 0.65rem;
        opacity: 0.8;
        font-weight: normal;
        margin-bottom: 4px;
      }
      .w-mg {
        font-size: 0.95rem;
        font-weight: bold;
      }

      /* Warna Status Setoran (Bisa Dipakai di Harian maupun Mingguan) */
      .done-barang {
        background: #4ade80;
        color: #000;
        box-shadow: 0 0 8px rgba(74, 222, 128, 0.4);
      }
      .done-uang {
        background: #ffd700;
        color: #000;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
      }
      .pend-barang {
        border: 1px solid #2b5c3b;
        color: #4ade80;
        background: #0a1f12;
      }
      .pend-uang {
        border: 1px solid #665600;
        color: #ffd700;
        background: #1f1a00;
      }

      .loader {
        text-align: center;
        padding: 50px;
        color: #ffd700;
      }
    </style>
  </head>
  <body>
    <header>
      <h1 class="title">Kalender Setoran</h1>
    </header>

    <div class="container" id="main-content">
      <div class="loader">
        <i class="fas fa-spinner fa-spin fa-2x"></i>
        <p style="font-size: 0.8rem; margin-top: 10px; color: #aaa">
          Memuat kalender...
        </p>
      </div>
    </div>

    <script>
      // MASUKKAN URL API ANDA DI SINI
      const URL_API =
        "https://script.google.com/macros/s/AKfycbxvy3DyvgYWyw6gKGhJ2K_Ai6fG9fixb4BdpqxH5dBt9XBQ3Fxcda9v-QZZTV09DXJKPw/exec";

      // Ambil Parameter dari URL
      const urlParams = new URLSearchParams(window.location.search);
      const paramId = urlParams.get("id") || "???";
      const paramNama = urlParams.get("nama") || "Peserta";
      const paramPaket = urlParams.get("paket") || "";
      const paramJumlah = parseInt(urlParams.get("jumlah")) || 0;

      // Cek apakah ini paket mingguan?
      const isMingguan = paramPaket.toLowerCase().includes("mingguan");

      async function loadData() {
        try {
          const response = await fetch(`${URL_API}?action=getPaket`);
          const dataPaket = await response.json();

          // Cari paket yang sesuai dengan peserta ini
          let detailPaket = dataPaket.find(
            (p) =>
              String(p.nama).trim().toLowerCase() ===
              String(paramPaket).trim().toLowerCase(),
          );

          // Default Fallback
          if (!detailPaket) {
            detailPaket = isMingguan
              ? { target_total: 40, target_barang: 40, target_uang: 0 }
              : { target_total: 330, target_barang: 130, target_uang: 200 };
          }

          renderUI(detailPaket);
        } catch (e) {
          console.error(e);
          alert("Gagal memuat data kalender. Menampilkan mode default.");
          renderUI(
            isMingguan
              ? { target_total: 40, target_barang: 40, target_uang: 0 }
              : { target_total: 330, target_barang: 130, target_uang: 200 },
          );
        }
      }

      function renderUI(paketInfo) {
        let tTotal =
          parseInt(paketInfo.target_total) || (isMingguan ? 40 : 330);
        const tBarang = parseInt(paketInfo.target_barang) || 0;
        const tUang = parseInt(paketInfo.target_uang) || 0;

        let html = `
            <div class="info-card">
                <div class="badge-paket">${paramPaket}</div>
                <h2 class="info-name">${paramNama}</h2>
                <div style="font-size:0.7rem; color:#666; font-family:monospace;">#${paramId}</div>
                
                <div class="target-detail-box">
                    <div class="td-item" style="color:#4ade80;"><i class="fas fa-box"></i> Brg: <b>${tBarang}x</b></div>
                    <div class="td-item" style="color:#ffd700;"><i class="fas fa-wallet"></i> Uang: <b>${tUang}x</b></div>
                </div>

                <div class="stats-grid">
                    <div class="stat-box">
                        <span class="stat-val green">${paramJumlah}</span>
                        <span class="stat-label">Sudah Setor</span>
                    </div>
                    <div class="stat-box">
                        <span class="stat-val gold">${tTotal}</span>
                        <span class="stat-label">Total Target</span>
                    </div>
                </div>
                <button class="btn-back" onclick="window.history.back()"><i class="fas fa-arrow-left"></i> Kembali</button>
            </div>

            <div class="legend-box">
                <div class="lg-item"><div class="lg-box lg-b-done"></div> Lunas (Barang)</div>
                <div class="lg-item"><div class="lg-box lg-u-done"></div> Lunas (Uang)</div>
                <div class="lg-item"><div class="lg-box lg-b-pend"></div> Belum (Barang)</div>
                <div class="lg-item"><div class="lg-box lg-u-pend"></div> Belum (Uang)</div>
            </div>
            
            <div id="calendar-area"></div>
        `;

        document.getElementById("main-content").innerHTML = html;

        // Pilih generator berdasarkan tipe paket
        if (isMingguan) {
          generateWeeklyCalendar(paramJumlah, tBarang, tTotal);
        } else {
          generateDailyCalendar(paramJumlah, tBarang, tTotal);
        }
      }

      // --- 1. GENERATOR KALENDER MINGGUAN (BARU) ---
      function generateWeeklyCalendar(setoranMasuk, targetBarang, totalTarget) {
        let html = "";

        // 1 April 2026 Jam 12 Siang
        let currentDate = new Date(2026, 3, 1, 12, 0, 0);
        let currentMonth = -1;
        let monthHtml = "";

        const namaBulan = [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ];

        for (let i = 1; i <= totalTarget; i++) {
          // Jika masuk bulan baru
          if (currentDate.getMonth() !== currentMonth) {
            if (currentMonth !== -1) {
              monthHtml += `</div></div>`;
              html += monthHtml;
            }

            currentMonth = currentDate.getMonth();
            let titleBulan = `${namaBulan[currentMonth]} ${currentDate.getFullYear()}`;

            // Header Bulan untuk Mingguan
            monthHtml = `
                    <div class="month-card">
                        <div class="month-title">${titleBulan}</div>
                        <div class="cal-grid-weekly">
                `;
          }

          let isDone = i <= setoranMasuk;
          let isBarang = i <= targetBarang;
          let cellClass = "weekly-cell ";

          if (isDone) cellClass += isBarang ? "done-barang" : "done-uang";
          else cellClass += isBarang ? "pend-barang" : "pend-uang";

          // Format Tanggal: misal "1 Apr"
          let tglStr = `${currentDate.getDate()} ${namaBulan[currentMonth].substring(0, 3)}`;

          // Cetak Kotak Minggu ke-X
          monthHtml += `
                <div class="${cellClass}">
                    <div class="w-tgl">${tglStr}</div>
                    <div class="w-mg">Mg-${i}</div>
                </div>
            `;

          // Maju 7 Hari untuk minggu berikutnya
          currentDate.setDate(currentDate.getDate() + 7);
        }

        if (monthHtml !== "") {
          monthHtml += `</div></div>`;
          html += monthHtml;
        }

        document.getElementById("calendar-area").innerHTML = html;
      }

      // --- 2. GENERATOR KALENDER HARIAN (SAMA SEPERTI SEBELUMNYA) ---
      function generateDailyCalendar(setoranMasuk, targetBarang, totalTarget) {
        let html = "";
        let currentDate = new Date(2026, 3, 1, 12, 0, 0);
        let currentMonth = -1;
        let monthHtml = "";

        const namaBulan = [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ];
        const hariArr = ["Mg", "Sn", "Sl", "Rb", "Km", "Jm", "Sb"];

        for (let i = 1; i <= totalTarget; i++) {
          if (currentDate.getMonth() !== currentMonth) {
            if (currentMonth !== -1) {
              monthHtml += `</div></div>`;
              html += monthHtml;
            }

            currentMonth = currentDate.getMonth();
            let titleBulan = `${namaBulan[currentMonth]} ${currentDate.getFullYear()}`;

            monthHtml = `
                    <div class="month-card">
                        <div class="month-title">${titleBulan}</div>
                        <div class="cal-grid">
                `;

            hariArr.forEach((d) => {
              monthHtml += `<div class="cal-head">${d}</div>`;
            });

            let firstDayIndex = currentDate.getDay();
            for (let e = 0; e < firstDayIndex; e++) {
              monthHtml += `<div class="cal-cell empty"></div>`;
            }
          }

          let isDone = i <= setoranMasuk;
          let isBarang = i <= targetBarang;
          let cellClass = "cal-cell ";

          if (isDone) cellClass += isBarang ? "done-barang" : "done-uang";
          else cellClass += isBarang ? "pend-barang" : "pend-uang";

          monthHtml += `<div class="${cellClass}">${currentDate.getDate()}</div>`;
          currentDate.setDate(currentDate.getDate() + 1);
        }

        if (monthHtml !== "") {
          monthHtml += `</div></div>`;
          html += monthHtml;
        }

        document.getElementById("calendar-area").innerHTML = html;
      }

      window.onload = loadData;
    </script>
  </body>
</html>
