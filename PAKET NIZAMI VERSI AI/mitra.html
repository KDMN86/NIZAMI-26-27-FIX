<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Portal Super Mitra - Nizami</title>
    <link rel="icon" href="data:;base64,iVBORw0KGgo=" />
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
      * {
        box-sizing: border-box;
        -webkit-tap-highlight-color: transparent;
      }
      body {
        background-color: #050505;
        color: #fff;
        font-family: "Poppins", sans-serif;
        margin: 0;
        padding-bottom: 120px;
        overflow-x: hidden;
      }

      /* HEADER MITRA */
      header {
        padding: 15px 20px;
        background: linear-gradient(180deg, #1f1500 0%, #050505 100%);
        position: sticky;
        top: 0;
        z-index: 50;
        border-bottom: 1px solid #332b00;
        display: flex;
        justify-content: space-between;
        align-items: center;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.8);
      }
      .head-title {
        margin: 0;
        color: #ffd700;
        font-size: 1.1rem;
        text-transform: uppercase;
        font-weight: bold;
      }
      .header-actions {
        display: flex;
        gap: 8px;
        align-items: center;
      }
      .btn-top {
        padding: 6px 12px;
        border-radius: 8px;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        transition: 0.2s;
        border: none;
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .btn-catalog {
        background: rgba(255, 215, 0, 0.15);
        color: #ffd700;
        border: 1px solid rgba(255, 215, 0, 0.3);
      }
      .btn-catalog:active {
        background: #ffd700;
        color: #000;
      }
      .btn-logout {
        background: rgba(255, 77, 77, 0.1);
        color: #ff4d4d;
        border: 1px solid rgba(255, 77, 77, 0.3);
        padding: 6px 10px;
      }
      .btn-logout:active {
        background: #ff4d4d;
        color: #fff;
      }

      .container {
        padding: 15px;
        max-width: 600px;
        margin: 0 auto;
      }

      /* STATISTIK DASHBOARD */
      .dashboard-hero {
        background: linear-gradient(145deg, #151515, #0a0a0a);
        border: 1px solid #333;
        border-radius: 16px;
        padding: 20px;
        margin-bottom: 15px;
        text-align: center;
      }
      .hero-name {
        font-size: 1.3rem;
        font-weight: bold;
        color: #fff;
        margin-bottom: 5px;
        text-transform: uppercase;
      }
      .hero-badge {
        display: inline-block;
        background: #ffd700;
        color: #000;
        font-size: 0.7rem;
        font-weight: bold;
        padding: 3px 10px;
        border-radius: 20px;
        margin-bottom: 15px;
      }
      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        border-top: 1px dashed #333;
        padding-top: 15px;
      }
      .stat-box {
        display: flex;
        flex-direction: column;
        align-items: center;
      }
      .stat-val {
        font-size: 1.3rem;
        font-weight: bold;
        color: #fff;
      }
      .stat-val.gold {
        color: #ffd700;
      }
      .stat-val.red {
        color: #ff6b6b;
      }
      .stat-label {
        font-size: 0.65rem;
        color: #888;
        text-transform: uppercase;
        margin-top: 2px;
      }

      /* TOMBOL AKSI DASHBOARD */
      .btn-tambah-peserta {
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed #4ade80;
        background: rgba(74, 222, 128, 0.1);
        color: #4ade80;
        font-weight: bold;
        font-size: 0.85rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
      }
      .btn-tambah-peserta:active {
        background: #4ade80;
        color: #000;
        border-style: solid;
      }

      /* TOMBOL PILIH BARANG (KUNING UNTUK FORM) */
      .btn-pilih-barang {
        width: 100%;
        padding: 12px;
        border-radius: 12px;
        border: 1px dashed #ffd700;
        background: rgba(255, 215, 0, 0.1);
        color: #ffd700;
        font-weight: bold;
        font-size: 0.9rem;
        cursor: pointer;
        transition: 0.2s;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-pilih-barang:active {
        background: #ffd700;
        color: #000;
        border-style: solid;
      }

      /* FILTER KAPSUL */
      .filter-wrapper {
        display: flex;
        gap: 8px;
        overflow-x: auto;
        padding-bottom: 10px;
        margin-bottom: 10px;
        scrollbar-width: none;
      }
      .filter-wrapper::-webkit-scrollbar {
        display: none;
      }
      .filter-chip {
        background: #1a1a1a;
        color: #888;
        border: 1px solid #333;
        padding: 8px 16px;
        border-radius: 50px;
        font-size: 0.8rem;
        font-weight: 600;
        white-space: nowrap;
        cursor: pointer;
        transition: 0.2s;
      }
      .filter-chip.active {
        background: #ffd700;
        color: #000;
        border-color: #ffd700;
      }

      /* KARTU PESERTA COMPACT */
      .peserta-card {
        background: #111;
        border: 1px solid #222;
        border-radius: 12px;
        padding: 12px 15px;
        margin-bottom: 10px;
        display: flex;
        flex-direction: column;
        transition: 0.2s;
      }
      .peserta-card.nunggak {
        border-left: 4px solid #ff6b6b;
      }
      .peserta-card.lancar {
        border-left: 4px solid #4ade80;
      }
      .peserta-card.lunas {
        border-left: 4px solid #3498db;
        opacity: 0.8;
      }
      .pc-head {
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .pc-info {
        flex: 1;
        padding-right: 10px;
      }
      .pc-right {
        flex-shrink: 0;
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      .pc-name {
        font-weight: bold;
        font-size: 1rem;
        color: #fff;
        margin-bottom: 4px;
        display: flex;
        align-items: center;
        flex-wrap: wrap;
        gap: 5px;
      }

      .badge-id,
      .badge-cal,
      .badge-wa {
        font-size: 0.65rem;
        padding: 2px 6px;
        border-radius: 4px;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        transition: 0.2s;
        font-weight: 600;
      }
      .badge-id {
        background: rgba(52, 152, 219, 0.1);
        color: #3498db;
        border: 1px solid rgba(52, 152, 219, 0.3);
      }
      .badge-id:active {
        background: #3498db;
        color: #fff;
      }
      .badge-cal {
        background: rgba(74, 222, 128, 0.1);
        color: #4ade80;
        border: 1px solid rgba(74, 222, 128, 0.3);
      }
      .badge-cal:active {
        background: #4ade80;
        color: #000;
      }
      .badge-wa {
        background: rgba(37, 211, 102, 0.1);
        color: #25d366;
        border: 1px solid rgba(37, 211, 102, 0.3);
      }
      .badge-wa:active {
        background: #25d366;
        color: #000;
      }

      .pc-paket {
        font-size: 0.65rem;
        color: #aaa;
        background: #222;
        padding: 2px 6px;
        border-radius: 4px;
        display: inline-block;
      }
      .pc-status {
        font-size: 0.7rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 5px;
        margin-top: 6px;
      }
      .pc-done {
        font-size: 1.3rem;
        font-weight: bold;
        color: #fff;
        line-height: 1;
      }

      /* INPUT DENGAN + DAN - */
      .stepper-control {
        display: flex;
        align-items: center;
        background: #000;
        border: 1px solid #333;
        border-radius: 6px;
        overflow: hidden;
        width: 90px;
        height: 28px;
        flex-shrink: 0;
      }
      .stepper-btn {
        background: #222;
        color: #4ade80;
        border: none;
        width: 28px;
        height: 100%;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
        transition: 0.1s;
      }
      .stepper-btn:active {
        background: #4ade80;
        color: #000;
      }
      .stepper-input {
        flex: 1;
        width: 100%;
        background: transparent;
        border: none;
        color: #fff;
        text-align: center;
        font-weight: bold;
        font-size: 0.85rem;
        -moz-appearance: textfield;
        outline: none;
        height: 100%;
        padding: 0;
      }
      .stepper-input::-webkit-outer-spin-button,
      .stepper-input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
      }

      .wa-action-box {
        border-top: 1px dashed #333;
        margin-top: 10px;
        padding-top: 10px;
      }
      .btn-wa {
        width: 100%;
        padding: 8px;
        border-radius: 8px;
        border: 1px solid rgba(255, 107, 107, 0.3);
        background: rgba(255, 107, 107, 0.1);
        color: #ff6b6b;
        font-size: 0.8rem;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 6px;
        transition: 0.2s;
      }
      .btn-wa:active {
        background: #ff6b6b;
        color: #000;
      }

      /* BATCH BAR */
      .batch-bar {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(15, 15, 15, 0.98);
        border-top: 1px solid #ffd700;
        z-index: 1000;
        box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.9);
        transform: translateY(100%);
        transition: transform 0.3s ease-out;
        display: flex;
        flex-direction: column;
        border-radius: 20px 20px 0 0;
      }
      .batch-bar.show {
        transform: translateY(0);
      }
      .bb-header {
        padding: 12px 20px;
        font-weight: bold;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 215, 0, 0.05);
        border-radius: 20px 20px 0 0;
        cursor: pointer;
      }
      .bb-header-title {
        color: #ffd700;
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .bb-toggle-icon {
        transition: transform 0.3s ease;
        color: #aaa;
      }
      .batch-details {
        max-height: 0;
        overflow-y: auto;
        padding: 0 20px;
        transition:
          max-height 0.3s ease,
          padding 0.3s ease;
      }
      .batch-bar.expanded .batch-details {
        max-height: 35vh;
        padding: 15px 20px 5px;
      }
      .batch-bar.expanded .bb-toggle-icon {
        transform: rotate(180deg);
        color: #ffd700;
      }
      .batch-item {
        display: flex;
        justify-content: space-between;
        color: #ddd;
        margin-bottom: 8px;
        border-bottom: 1px dashed #333;
        padding-bottom: 8px;
        align-items: center;
      }
      .batch-summary {
        padding: 15px 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: #050505;
      }
      .bs-label {
        font-size: 0.75rem;
        color: #888;
        margin-bottom: 2px;
      }
      .bs-val {
        font-size: 1.2rem;
        font-weight: bold;
        color: #4ade80;
      }
      .btn-checkout {
        background: #ffd700;
        color: #000;
        border: none;
        padding: 12px 20px;
        border-radius: 50px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        gap: 8px;
        align-items: center;
        box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
        font-size: 0.9rem;
      }

      /* MODAL UMUM & INPUT FORM */
      .modal-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        display: none;
        justify-content: center;
        align-items: center;
        padding: 20px 0;
        backdrop-filter: blur(5px);
      }
      .modal-overlay.show {
        display: flex;
        animation: fadeIn 0.3s;
      }
      .modal-card {
        background: #1a1a1a;
        border-radius: 15px;
        width: 90%;
        max-width: 450px;
        border: 1px solid #333;
        position: relative;
      }
      .input-dark {
        width: 100%;
        padding: 12px;
        background: #000;
        border: 1px solid #444;
        color: #fff;
        border-radius: 8px;
        font-family: "Poppins", sans-serif;
      }
      .input-dark:focus {
        border-color: #4ade80;
        outline: none;
      }
      #preview-img-container {
        text-align: center;
        background: #111;
        padding: 10px;
        border-radius: 10px;
        margin-bottom: 15px;
        border: 1px solid #333;
      }
      #preview-img-container img {
        max-width: 100%;
        max-height: 50vh;
        object-fit: contain;
        border-radius: 5px;
      }
      #struk-area {
        position: absolute;
        top: 0;
        left: -9999px;
        width: 360px;
        background: #fff;
        color: #000;
        padding: 20px;
        font-family: "Courier New", Courier, monospace;
      }
      #toast {
        position: fixed;
        top: 80px;
        left: 50%;
        transform: translateX(-50%);
        background: #4ade80;
        color: #000;
        padding: 10px 20px;
        border-radius: 50px;
        font-weight: bold;
        font-size: 0.85rem;
        box-shadow: 0 4px 15px rgba(74, 222, 128, 0.4);
        z-index: 99999;
        display: none;
        align-items: center;
        gap: 8px;
        transition: opacity 0.3s;
      }
      .loader {
        text-align: center;
        padding: 50px;
        color: #888;
        font-size: 0.9rem;
      }

      /* SELECTOR PAKET MASAL & ACCORDION */
      .cs-select {
        width: 100%;
        padding: 12px;
        background: #222;
        color: #fff;
        border: 1px solid #444;
        border-radius: 8px;
        font-size: 0.9rem;
        outline: none;
      }
      .cs-select:focus {
        border-color: #ffd700;
      }
      .btn-fab-add {
        width: 100%;
        background: #222;
        color: #fff;
        border: 1px dashed #555;
        padding: 15px;
        border-radius: 12px;
        font-weight: bold;
        font-size: 0.95rem;
        cursor: pointer;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
      }
      .btn-fab-add:active {
        background: #333;
      }

      .accordion-header {
        background: #1a1a1a;
        border: 1px solid #333;
        padding: 15px;
        border-radius: 8px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: bold;
        color: #ffd700;
        cursor: pointer;
        transition: background 0.2s;
        position: -webkit-sticky;
        position: sticky;
        top: -1px;
        z-index: 10;
        box-shadow: 0 10px 20px -5px rgba(0, 0, 0, 0.9);
      }
      .accordion-header:active {
        background: #2a2a2a;
      }
      .accordion-body {
        background: #0a0a0a;
        border: 1px solid #222;
        border-top: none;
        padding: 0 15px;
        border-radius: 0 0 8px 8px;
        margin-bottom: 15px;
        margin-top: -5px;
      }

      /* ITEM SETOR MASAL COMPACT */
      .sm-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #222;
        padding: 12px 0;
      }
      .sm-info {
        flex: 1;
        padding-right: 10px;
      }
      .sm-name {
        font-weight: bold;
        font-size: 0.95rem;
        color: #fff;
        margin-bottom: 2px;
      }
      .sm-paket {
        font-size: 0.7rem;
        color: #888;
        margin-bottom: 4px;
      }
      .sm-calc {
        font-size: 0.75rem;
        color: #aaa;
        background: #222;
        display: inline-block;
        padding: 2px 8px;
        border-radius: 4px;
      }
      .sm-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 6px;
      }
      .sm-subtotal {
        font-weight: bold;
        color: #ffd700;
        font-size: 0.9rem;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }
    </style>
  </head>
  <body>
    <div id="toast">
      <i class="fas fa-check-circle"></i><span id="toastMsg">Disimpan</span>
    </div>

    <header>
      <h1 class="head-title">
        <i class="fas fa-user-tie" style="margin-right: 8px"></i> Portal Mitra
      </h1>
      <div class="header-actions">
        <button
          class="btn-top btn-catalog"
          onclick="window.location.href = 'index.html'"
        >
          <i class="fas fa-box-open"></i> Katalog
        </button>
        <button class="btn-top btn-logout" onclick="logoutMitra()">
          <i class="fas fa-sign-out-alt"></i>
        </button>
      </div>
    </header>

    <div class="container">
      <div class="dashboard-hero">
        <div class="hero-name" id="mitraName">Memuat...</div>
        <div class="hero-badge">MITRA NIZAMI</div>
        <div class="stats-grid">
          <div class="stat-box">
            <span class="stat-val" id="stat-total">0</span
            ><span class="stat-label">Peserta</span>
          </div>
          <div class="stat-box">
            <span class="stat-val red" id="stat-nunggak">0</span
            ><span class="stat-label">Nunggak</span>
          </div>
          <div class="stat-box">
            <span class="stat-val gold" id="stat-lancar">0</span
            ><span class="stat-label">Lancar/Lunas</span>
          </div>
        </div>

        <div style="display: flex; gap: 10px; margin-top: 15px">
          <button
            class="btn-tambah-peserta"
            style="margin-top: 0; flex: 1"
            onclick="bukaModalDaftarBaru()"
          >
            <i class="fas fa-user-plus"></i> Peserta Baru
          </button>
          <button
            class="btn-tambah-peserta"
            style="
              margin-top: 0;
              flex: 1;
              border-color: #3498db;
              color: #3498db;
              background: rgba(52, 152, 219, 0.1);
            "
            onclick="bukaModalSetorMasal()"
          >
            <i class="fas fa-list-check"></i> Setor Masal
          </button>
        </div>
      </div>

      <div class="filter-wrapper">
        <div
          class="filter-chip active"
          id="flt-semua"
          onclick="applyFilter('semua')"
        >
          Semua
        </div>
        <div
          class="filter-chip"
          id="flt-nunggak"
          onclick="applyFilter('nunggak')"
        >
          ðŸ”´ Perlu Ditagih
        </div>
        <div
          class="filter-chip"
          id="flt-lancar"
          onclick="applyFilter('lancar')"
        >
          ðŸŸ¢ Lancar
        </div>
        <div class="filter-chip" id="flt-lunas" onclick="applyFilter('lunas')">
          ðŸ”µ Lunas
        </div>
      </div>

      <div id="pesertaContainer">
        <div class="loader">
          <i class="fas fa-spinner fa-spin fa-2x"></i><br /><br />Memproses
          data...
        </div>
      </div>
    </div>

    <div id="batchBar" class="batch-bar">
      <div class="bb-header" onclick="toggleBatchCart()">
        <div class="bb-header-title">
          <i class="fas fa-book"></i> Draft (<span id="cartCountBadge">0</span>)
          <i class="fas fa-chevron-up bb-toggle-icon"></i>
        </div>
        <span
          onclick="clearBatchCart(event)"
          style="
            color: #ff6b6b;
            font-size: 0.75rem;
            background: rgba(255, 107, 107, 0.1);
            padding: 4px 8px;
            border-radius: 6px;
            border: 1px solid rgba(255, 107, 107, 0.3);
          "
          ><i class="fas fa-trash"></i> Hapus</span
        >
      </div>
      <div class="batch-details" id="batchDetails"></div>
      <div class="batch-summary">
        <div>
          <span class="bs-label">Total Uang ke Admin</span>
          <div class="bs-val" id="batchTotalRp">Rp 0</div>
        </div>
        <button class="btn-checkout" onclick="generateStruk()">
          <i class="fas fa-camera"></i> Buat Struk
        </button>
      </div>
    </div>

    <div id="modalPreviewImg" class="modal-overlay">
      <div class="modal-card">
        <div
          style="
            text-align: center;
            color: #4ade80;
            font-weight: bold;
            font-size: 1.2rem;
            margin-bottom: 5px;
          "
        >
          Struk Berhasil Dibuat!
        </div>
        <p
          style="
            text-align: center;
            color: #888;
            font-size: 0.75rem;
            margin-bottom: 15px;
          "
        >
          Kirim struk ini ke Admin bersama bukti transfer.
        </p>
        <div id="preview-img-container"></div>
        <div style="display: flex; gap: 10px">
          <button
            onclick="downloadStruk()"
            style="
              flex: 1;
              padding: 12px;
              border-radius: 8px;
              border: none;
              font-weight: bold;
              cursor: pointer;
              background: #333;
              color: #fff;
            "
          >
            <i class="fas fa-download"></i> Simpan
          </button>
          <button
            onclick="kirimWaAdmin()"
            style="
              flex: 2;
              padding: 12px;
              border-radius: 8px;
              border: none;
              font-weight: bold;
              cursor: pointer;
              background: #ffd700;
              color: #000;
            "
          >
            <i class="fab fa-whatsapp"></i> WA Admin
          </button>
        </div>
        <button
          onclick="tutupPreviewImg()"
          style="
            width: 100%;
            margin-top: 10px;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #444;
            background: transparent;
            color: #aaa;
            cursor: pointer;
          "
        >
          Tutup
        </button>
      </div>
    </div>

    <div id="modalSetorMasal" class="modal-overlay" style="z-index: 9999">
      <div
        class="modal-card"
        style="
          padding: 0;
          overflow: hidden;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          style="
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            background: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0; color: #3498db">
            <i class="fas fa-list-check"></i> Setoran Masal
          </h3>
          <button
            style="
              background: none;
              border: none;
              color: #aaa;
              font-size: 1.5rem;
              cursor: pointer;
            "
            onclick="tutupModalSetorMasal()"
          >
            &times;
          </button>
        </div>
        <div id="smBody" style="padding: 15px; overflow-y: auto; flex: 1"></div>
        <div
          style="
            padding: 15px;
            background: #050505;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <div style="font-size: 0.7rem; color: #888">
              Total Setoran Keseluruhan
            </div>
            <div
              id="smTotalRp"
              style="color: #4ade80; font-weight: bold; font-size: 1.1rem"
            >
              Rp 0
            </div>
          </div>
          <button
            onclick="tutupModalSetorMasal()"
            class="btn-checkout"
            style="background: #3498db; padding: 10px 15px"
          >
            <i class="fas fa-save"></i> Simpan Draft
          </button>
        </div>
      </div>
    </div>

    <div id="modalDaftarBaru" class="modal-overlay">
      <div
        class="modal-card"
        style="
          padding: 0;
          overflow: hidden;
          max-height: 95vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          style="
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            background: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0; color: #4ade80">
            <i class="fas fa-user-plus"></i> Form Pendaftaran
          </h3>
          <button
            style="
              background: none;
              border: none;
              color: #aaa;
              font-size: 1.5rem;
              cursor: pointer;
            "
            onclick="tutupModalDaftarBaru()"
          >
            &times;
          </button>
        </div>

        <div
          style="padding: 15px; overflow-y: auto; flex: 1"
          id="scrollFormArea"
        >
          <form id="formPendaftaran" onsubmit="submitDaftarPesertaWA(event)">
            <div id="formsContainerMitra"></div>

            <button
              type="button"
              class="btn-fab-add"
              onclick="addParticipantRowMitra()"
            >
              <i class="fas fa-plus"></i> Tambah Peserta Lain
            </button>

            <button
              type="submit"
              class="btn-checkout"
              style="
                width: 100%;
                background: #4ade80;
                color: #000;
                justify-content: center;
                padding: 15px;
              "
            >
              <i class="fas fa-paper-plane"></i> Kirim Pendaftaran via WA
            </button>
          </form>
        </div>
      </div>
    </div>

    <div id="modalPilihBarang" class="modal-overlay" style="z-index: 10000">
      <div
        class="modal-card"
        style="
          padding: 0;
          overflow: hidden;
          max-height: 90vh;
          display: flex;
          flex-direction: column;
        "
      >
        <div
          style="
            padding: 15px 20px;
            border-bottom: 1px solid #333;
            background: #111;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <h3 style="margin: 0; color: #ffd700; font-size: 1.1rem" id="pbTitle">
            <i class="fas fa-box-open"></i> Pilih Barang
          </h3>
          <button
            type="button"
            style="
              background: none;
              border: none;
              color: #aaa;
              font-size: 1.5rem;
              cursor: pointer;
            "
            onclick="tutupPilihBarang()"
          >
            &times;
          </button>
        </div>

        <div
          id="pbBody"
          style="
            padding: 0 15px 15px 15px;
            overflow-y: auto;
            flex: 1;
            position: relative;
          "
        ></div>

        <div
          id="pbSelectedItems"
          style="
            padding: 10px 15px;
            background: #1a1a1a;
            border-top: 1px solid #333;
            max-height: 120px;
            overflow-y: auto;
            display: none;
          "
        ></div>

        <div
          style="
            padding: 15px;
            background: #050505;
            border-top: 1px solid #333;
            display: flex;
            justify-content: space-between;
            align-items: center;
          "
        >
          <div>
            <div style="font-size: 0.7rem; color: #888" id="pbTotalLabel">
              Total Nilai Barang
            </div>
            <div
              id="pbTotal"
              style="color: #4ade80; font-weight: bold; font-size: 1.1rem"
            >
              Rp 0
            </div>
          </div>
          <button
            type="button"
            onclick="selesaiPilihBarang()"
            class="btn-checkout"
            style="padding: 10px 15px"
          >
            <i class="fas fa-check"></i> Selesai
          </button>
        </div>
      </div>
    </div>

    <div id="struk-area">
      <div
        style="
          text-align: center;
          border-bottom: 2px dashed #000;
          padding-bottom: 10px;
          margin-bottom: 10px;
        "
      >
        <h2 style="margin: 0; letter-spacing: 1px">SETORAN MITRA</h2>
        <div style="font-size: 10px; color: #444">
          Nizami Paket Lebaran 2026-2027
        </div>
        <div id="struk-date" style="font-size: 11px; margin-top: 5px"></div>
        <div
          id="struk-mitra"
          style="font-size: 13px; font-weight: bold; margin-top: 8px"
        ></div>
      </div>
      <div id="struk-items"></div>
      <div
        style="
          border-top: 2px dashed #000;
          padding-top: 10px;
          margin-top: 10px;
          font-weight: bold;
          display: flex;
          justify-content: space-between;
          font-size: 14px;
        "
      >
        <span>TOTAL SETOR:</span><span id="struk-total-val">Rp 0</span>
      </div>
    </div>

    <script src="script.js"></script>

    <script>
      let rawPesertaData = [];
      let batchCart = {};
      let base64StrukImg = "";
      let userId = "";

      // VARIABEL DAFTAR MASAL MULTI-PAKET
      let masterPaket = [];
      let masterBarang = [];
      let formCountMitra = 0;

      let currentEditingRowIdMitra = null;
      let currentEditingPkgIdMitra = null;
      let rowDataMitra = {};

      // VARIABEL GLOBAL UNTUK AUTO-FILL
      let globalMitraHp = localStorage.getItem("mitra_hp_cache") || "";
      let globalMitraAlamat = localStorage.getItem("mitra_alamat_cache") || "";

      window.onload = async () => {
        const urlParams = new URLSearchParams(window.location.search);
        const magicId = urlParams.get("id");
        if (magicId) {
          await processAutoLogin(magicId);
        } else {
          checkLocalSession();
        }
      };

      async function processAutoLogin(id) {
        document.getElementById("mitraName").innerText = "Memverifikasi...";
        const data = await fetchData("cekStatusDetail", { id: id });
        if (data && !data.error && data.type === "MITRA") {
          const userData = {
            id: id,
            type: "MITRA",
            nama: data.nama || "Mitra",
            paket: "MITRA",
          };
          localStorage.setItem("nizami_user", JSON.stringify(userData));
          window.history.replaceState({}, document.title, "mitra.html");
          userId = id;
          initMitraPage(userData);
        } else {
          alert("Link tidak valid atau Anda bukan Mitra.");
          window.location.href = "index.html";
        }
      }

      function checkLocalSession() {
        const userStr = localStorage.getItem("nizami_user");
        if (!userStr) {
          window.location.href = "index.html";
          return;
        }
        const user = JSON.parse(userStr);
        if (user.type !== "MITRA") {
          window.location.href = "index.html";
          return;
        }
        userId = user.id;
        initMitraPage(user);
      }

      async function initMitraPage(user) {
        document.getElementById("mitraName").innerText = user.nama;
        const savedDraft = localStorage.getItem("mitra_draft_" + userId);
        if (savedDraft) {
          batchCart = JSON.parse(savedDraft);
          for (let k in batchCart) {
            if (!batchCart[k].date || batchCart[k].date === "-")
              batchCart[k].date = getFormattedDate();
          }
        }
        try {
          // KITA PANGGIL 'getMitra' JUGA UNTUK MENDAPATKAN WA & ALAMAT MITRA
          const [resPeserta, resPaket, resBarang, resMitra] = await Promise.all(
            [
              fetchData("cekStatusDetail", { id: userId }),
              fetchData("getPaket"),
              fetchData("getBarang"),
              fetchData("getMitra"),
            ],
          );

          if (resPaket) masterPaket = Array.isArray(resPaket) ? resPaket : [];
          if (resBarang)
            masterBarang = Array.isArray(resBarang) ? resBarang : [];

          // EKSTRAKSI AUTO-FILL DATA MITRA DARI DATABASE
          if (resMitra && Array.isArray(resMitra)) {
            let mData = resMitra.find(
              (m) =>
                m.id === userId ||
                (m.nama &&
                  m.nama.trim().toLowerCase() ===
                    user.nama.trim().toLowerCase()),
            );
            if (mData) {
              for (let key in mData) {
                let k = key.toLowerCase().replace(/[^a-z0-9]/g, "");
                if (
                  ["nohp", "hp", "nowa", "wa", "nomorhp"].includes(k) &&
                  mData[key]
                )
                  globalMitraHp = mData[key];
                if (k.includes("alamat") && mData[key])
                  globalMitraAlamat = mData[key];
              }
            }
          }
          // SIMPAN HASIL EKSTRAKSI KE CACHE LOKAL
          if (globalMitraHp)
            localStorage.setItem("mitra_hp_cache", globalMitraHp);
          if (globalMitraAlamat)
            localStorage.setItem("mitra_alamat_cache", globalMitraAlamat);

          if (resPeserta && resPeserta.data && resPeserta.data.length > 0) {
            rawPesertaData = resPeserta.data.map((item) => {
              let no_hp_db = "";
              for (let key in item) {
                let cleanKey = key.toLowerCase().replace(/[^a-z0-9]/g, "");
                if (
                  [
                    "nohp",
                    "hp",
                    "nowa",
                    "wa",
                    "nomorhp",
                    "telepon",
                    "whatsapp",
                  ].includes(cleanKey)
                ) {
                  no_hp_db = item[key];
                  break;
                }
              }
              return {
                id: item.id || item.id_peserta || item.idpeserta,
                nama: item.nama || item.nama_peserta,
                hp: no_hp_db,
                paket: item.paket || item.jenis_paket,
                done: parseInt(item.tercapai) || 0,
                target: parseInt(item.target) || 330,
                harga: parseInt(item.nilai) || 0,
              };
            });
            processAndRender(rawPesertaData);
          } else {
            document.getElementById("pesertaContainer").innerHTML =
              '<div style="text-align:center; color:#888; padding:30px;">Belum ada peserta terdaftar.</div>';
          }
        } catch (e) {
          console.error("Gagal load data", e);
        }
      }

      function getFormattedDate() {
        const now = new Date();
        const monthNames = [
          "Jan",
          "Feb",
          "Mar",
          "Apr",
          "Mei",
          "Jun",
          "Jul",
          "Agt",
          "Sep",
          "Okt",
          "Nov",
          "Des",
        ];
        return `${now.getDate()} ${monthNames[now.getMonth()]} - ${String(now.getHours()).padStart(2, "0")}:${String(now.getMinutes()).padStart(2, "0")}`;
      }

      function getStatusCalculation(paketName, done, target) {
        let isMingguan = paketName.toLowerCase().includes("mingguan");
        let startDate = new Date(2026, 3, 1);
        startDate.setHours(0, 0, 0, 0);
        let today = new Date();
        today.setHours(0, 0, 0, 0);
        let expected = 0;
        if (today >= startDate) {
          let diffTime = today.getTime() - startDate.getTime();
          let diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
          expected = isMingguan ? Math.floor(diffDays / 7) + 1 : diffDays + 1;
        }
        if (expected > target) expected = target;

        let selisih = done - expected;
        let statusKategori = "lancar",
          text = "",
          colorClass = "text-green",
          icon = "fa-check-circle";
        if (done >= target) {
          statusKategori = "lunas";
          text = "LUNAS";
          colorClass = "text-blue";
          icon = "fa-medal";
        } else if (selisih < 0) {
          statusKategori = "nunggak";
          text = `Telat ${Math.abs(selisih)}x Setor`;
          colorClass = "text-red";
          icon = "fa-exclamation-circle";
        } else {
          statusKategori = "lancar";
          text = `Aman (Lebih ${selisih}x)`;
          colorClass = "text-green";
          icon = "fa-check-circle";
        }
        return {
          kategori: statusKategori,
          text: text,
          colorClass: colorClass,
          icon: icon,
          telatCount: Math.abs(selisih),
        };
      }

      function processAndRender(data) {
        let total = data.length,
          nunggak = 0,
          lancarLunas = 0;
        data.forEach((p) => {
          p.kalkulasi = getStatusCalculation(p.paket, p.done, p.target);
          if (p.kalkulasi.kategori === "nunggak") nunggak++;
          else lancarLunas++;
        });
        document.getElementById("stat-total").innerText = total;
        document.getElementById("stat-nunggak").innerText = nunggak;
        document.getElementById("stat-lancar").innerText = lancarLunas;
        applyFilter("semua");
      }

      function applyFilter(tipe) {
        document
          .querySelectorAll(".filter-chip")
          .forEach((el) => el.classList.remove("active"));
        document.getElementById(`flt-${tipe}`).classList.add("active");
        const container = document.getElementById("pesertaContainer");
        container.innerHTML = "";
        let filtered = rawPesertaData;
        if (tipe !== "semua")
          filtered = rawPesertaData.filter(
            (p) => p.kalkulasi.kategori === tipe,
          );

        if (filtered.length === 0) {
          container.innerHTML = `<div style="text-align:center; padding:30px; color:#666;">Tidak ada peserta di kategori ini.</div>`;
          return;
        }

        filtered.forEach((p) => {
          const kal = p.kalkulasi;
          let cardStyle = "lancar";
          if (kal.kategori === "nunggak") cardStyle = "nunggak";
          if (kal.kategori === "lunas") cardStyle = "lunas";
          let qtyCart = batchCart[p.id] ? batchCart[p.id].qty : 0;

          let idBtnHtml = `<span class="badge-id" onclick="window.location.href='kartu-digital.html?id=${p.id}'" title="Kartu Digital"><i class="fas fa-id-card"></i> ${p.id}</span>`;
          let kalenderBtnHtml = `<span class="badge-cal" onclick="window.location.href='kalender.html?id=${p.id}&nama=${encodeURIComponent(p.nama)}&paket=${encodeURIComponent(p.paket)}&jumlah=${p.done}'" title="Kalender Setoran"><i class="far fa-calendar-alt"></i></span>`;
          let waBtnHtml = `<span class="badge-wa" onclick="hubungiWA('${p.hp || ""}', '${p.nama.replace(/'/g, "\\'")}')" title="Hubungi WA Peserta"><i class="fab fa-whatsapp"></i></span>`;

          let stepperHtml = "";
          if (kal.kategori !== "lunas") {
            stepperHtml = `<div class="stepper-control"><button class="stepper-btn" onclick="updateDraft('${p.id}', '${p.nama.replace(/'/g, "\\'")}', '${p.paket}', ${p.harga}, ${p.done}, -1)">-</button><input type="number" class="stepper-input" id="draft-input-${p.id}" value="${qtyCart}" onchange="setDraft('${p.id}', '${p.nama.replace(/'/g, "\\'")}', '${p.paket}', ${p.harga}, ${p.done}, this.value)" /><button class="stepper-btn" onclick="updateDraft('${p.id}', '${p.nama.replace(/'/g, "\\'")}', '${p.paket}', ${p.harga}, ${p.done}, 1)">+</button></div>`;
          } else {
            stepperHtml = `<div style="font-size:0.75rem; color:#3498db; font-weight:bold;"><i class="fas fa-check-circle"></i> Selesai</div>`;
          }

          let btnWaTunggakanHtml = "";
          if (kal.kategori === "nunggak" && p.harga > 0) {
            btnWaTunggakanHtml = `<div class="wa-action-box"><button class="btn-wa" onclick="tagihWA('${p.hp || ""}', '${p.nama.replace(/'/g, "\\'")}', '${p.paket}', ${kal.telatCount}, ${p.harga * kal.telatCount})"><i class="fab fa-whatsapp" style="font-size:1rem;"></i> Tagih Tunggakan (Rp ${(p.harga * kal.telatCount).toLocaleString("id-ID")})</button></div>`;
          }

          container.insertAdjacentHTML(
            "beforeend",
            `
            <div class="peserta-card ${cardStyle}">
              <div class="pc-head">
                <div class="pc-info">
                  <div class="pc-name">${p.nama} ${idBtnHtml} ${kalenderBtnHtml} ${waBtnHtml}</div>
                  <div class="pc-paket">${p.paket}</div>
                  <div class="pc-status ${kal.colorClass}"><i class="fas ${kal.icon}"></i> ${kal.text}</div>
                </div>
                <div class="pc-right">
                  <div class="pc-done">${p.done}<span style="font-size:0.75rem; color:#888;">/${p.target}</span></div>
                  ${stepperHtml}
                </div>
              </div>
              ${btnWaTunggakanHtml}
            </div>`,
          );
        });
        updateBatchUI();
      }

      function hubungiWA(hp, nama) {
        if (!hp || hp.trim() === "" || hp === "undefined" || hp === "null") {
          alert(
            "Nomor WhatsApp tidak tersedia/belum diinput untuk peserta ini di Database.",
          );
          return;
        }
        let hpClean = String(hp).replace(/\D/g, "");
        if (hpClean.startsWith("0")) hpClean = "62" + hpClean.substring(1);
        let txt = `Assalamu'alaikum Kak *${nama}*,\n\nIni dengan admin/mitra dari Tabungan Nizami.`;
        window.open(
          `https://wa.me/${hpClean}?text=${encodeURIComponent(txt)}`,
          "_blank",
        );
      }

      function tagihWA(hp, nama, paket, telat, nominal) {
        let hpClean = String(hp || "").replace(/\D/g, "");
        if (hpClean.startsWith("0")) hpClean = "62" + hpClean.substring(1);
        let txt = `Assalamu'alaikum Kak *${nama}*,\n\nSekadar mengingatkan untuk setoran *${paket}* saat ini ada keterlambatan *${telat}x setoran* (Total: Rp ${nominal.toLocaleString("id-ID")}).\n\nYuk semangat nabungnya biar Lebaran panen! ðŸ™`;
        if (hpClean && hpClean.length > 8) {
          window.open(
            `https://wa.me/${hpClean}?text=${encodeURIComponent(txt)}`,
            "_blank",
          );
        } else {
          alert(
            "Sistem tidak mendeteksi Nomor HP di database. Dialihkan ke share WA manual.",
          );
          window.open(`whatsapp://send?text=${encodeURIComponent(txt)}`);
        }
      }

      // ==========================================
      // FUNGSI MODAL SETOR MASAL
      // ==========================================
      function bukaModalSetorMasal() {
        renderSetorMasal();
        document.getElementById("modalSetorMasal").classList.add("show");
      }
      function tutupModalSetorMasal() {
        document.getElementById("modalSetorMasal").classList.remove("show");
        saveDraftAndRender();
      }
      function renderSetorMasal() {
        const body = document.getElementById("smBody");
        if (rawPesertaData.length === 0) {
          body.innerHTML = `<div style="text-align:center; padding:20px; color:#888;">Belum ada peserta.</div>`;
          return;
        }
        let html = "";
        let totalRp = 0;
        rawPesertaData.forEach((p) => {
          let qty = batchCart[p.id] ? batchCart[p.id].qty : 0;
          let subtotal = qty * p.harga;
          totalRp += subtotal;
          let curr = p.done + qty;
          html += `<div class="sm-item" id="sm_row_${p.id}"><div class="sm-info"><div class="sm-name">${p.nama}</div><div class="sm-paket">${p.paket}</div><div class="sm-calc" id="sm_calc_${p.id}"><i class="fas fa-history"></i> Setoran: ${p.done} âž” <b style="color:#fff">${curr}</b></div></div><div class="sm-right"><div class="sm-subtotal" id="sm_sub_${p.id}">Rp ${subtotal.toLocaleString("id-ID")}</div><div class="stepper-control"><button type="button" class="stepper-btn" onclick="updateQtySM('${p.id}', '${p.nama.replace(/'/g, "\\'")}', '${p.paket}', ${p.harga}, ${p.done}, -1)">-</button><input type="number" readonly class="stepper-input" id="sm_qty_${p.id}" value="${qty}"><button type="button" class="stepper-btn" onclick="updateQtySM('${p.id}', '${p.nama.replace(/'/g, "\\'")}', '${p.paket}', ${p.harga}, ${p.done}, 1)">+</button></div></div></div>`;
        });
        body.innerHTML = html;
        document.getElementById("smTotalRp").innerText =
          "Rp " + totalRp.toLocaleString("id-ID");
      }
      function updateQtySM(id, nama, paket, harga, done, change) {
        if (!batchCart[id]) {
          batchCart[id] = {
            nama: nama,
            paket: paket,
            harga: harga,
            currentDone: done,
            qty: 0,
          };
        }
        batchCart[id].qty += change;
        if (batchCart[id].qty < 0) batchCart[id].qty = 0;
        batchCart[id].date = getFormattedDate();
        if (batchCart[id].qty <= 0) {
          delete batchCart[id];
        }
        let newQty = batchCart[id] ? batchCart[id].qty : 0;
        let newSub = newQty * harga;
        let newCurr = done + newQty;
        document.getElementById(`sm_qty_${id}`).value = newQty;
        document.getElementById(`sm_calc_${id}`).innerHTML =
          `<i class="fas fa-history"></i> Setoran: ${done} âž” <b style="color:#fff">${newCurr}</b>`;
        document.getElementById(`sm_sub_${id}`).innerText =
          "Rp " + newSub.toLocaleString("id-ID");
        let totalRp = 0;
        for (let k in batchCart) {
          totalRp += batchCart[k].qty * batchCart[k].harga;
        }
        document.getElementById("smTotalRp").innerText =
          "Rp " + totalRp.toLocaleString("id-ID");
      }

      function updateDraft(id, nama, paket, harga, currentDone, change) {
        if (!batchCart[id]) {
          batchCart[id] = {
            nama: nama,
            paket: paket,
            harga: harga,
            currentDone: currentDone,
            qty: 0,
          };
        }
        batchCart[id].qty += change;
        batchCart[id].date = getFormattedDate();
        if (batchCart[id].qty <= 0) delete batchCart[id];
        saveDraftAndRender();
        if (change > 0) showToast("Tersimpan di Draft!");
      }
      function setDraft(id, nama, paket, harga, currentDone, val) {
        let qty = parseInt(val) || 0;
        if (qty <= 0) {
          delete batchCart[id];
        } else {
          if (!batchCart[id])
            batchCart[id] = {
              nama: nama,
              paket: paket,
              harga: harga,
              currentDone: currentDone,
              qty: 0,
            };
          batchCart[id].qty = qty;
          batchCart[id].date = getFormattedDate();
        }
        saveDraftAndRender();
        showToast("Tersimpan di Draft!");
      }
      function hapusDariBatch(id) {
        delete batchCart[id];
        saveDraftAndRender();
      }
      function clearBatchCart(e) {
        if (e) e.stopPropagation();
        if (confirm("Yakin hapus draft setoran?")) {
          batchCart = {};
          localStorage.removeItem("mitra_draft_" + userId);
          document
            .querySelectorAll(".stepper-input")
            .forEach((inp) => (inp.value = 0));
          updateBatchUI();
          document.getElementById("batchBar").classList.remove("expanded");
        }
      }
      function saveDraftAndRender() {
        localStorage.setItem(
          "mitra_draft_" + userId,
          JSON.stringify(batchCart),
        );
        document.querySelectorAll(".stepper-input").forEach((inp) => {
          let pid = inp.id.replace("draft-input-", "");
          inp.value = batchCart[pid] ? batchCart[pid].qty : 0;
        });
        updateBatchUI();
      }
      function toggleBatchCart() {
        const bar = document.getElementById("batchBar");
        if (Object.keys(batchCart).length > 0) bar.classList.toggle("expanded");
      }
      function updateBatchUI() {
        let totalUang = 0,
          countItem = 0,
          html = "";
        for (let id in batchCart) {
          let item = batchCart[id];
          if (!item.date || item.date === "-") item.date = getFormattedDate();
          let subtotal = item.qty * item.harga;
          totalUang += subtotal;
          countItem++;
          html += `<div class="batch-item"><div style="max-width:65%;"><div style="font-weight:bold; color:#fff; font-size: 0.9rem;">${item.nama} <span style="color:#ffd700; font-size:0.8rem; margin-left: 5px;">x${item.qty}</span></div><div style="font-size:0.65rem; color:#888;">${item.paket}</div><div style="font-size:0.6rem; color:#4ade80; margin-top:4px;"><i class="far fa-clock"></i> Draft: ${item.date}</div></div><div style="display:flex; flex-direction:column; align-items:flex-end; gap:6px;"><span style="color:#4ade80; font-weight:bold; font-size: 0.9rem;">Rp ${subtotal.toLocaleString("id-ID")}</span><i class="fas fa-trash" style="color:#ff6b6b; cursor:pointer; font-size:0.9rem; background: #222; padding: 5px 8px; border-radius: 4px;" onclick="hapusDariBatch('${id}')"></i></div></div>`;
        }
        document.getElementById("batchDetails").innerHTML = html;
        document.getElementById("batchTotalRp").innerText =
          `Rp ${totalUang.toLocaleString("id-ID")}`;
        document.getElementById("cartCountBadge").innerText = countItem;
        const bar = document.getElementById("batchBar");
        if (countItem > 0) bar.classList.add("show");
        else {
          bar.classList.remove("show");
          bar.classList.remove("expanded");
        }
      }

      function generateStruk() {
        if (Object.keys(batchCart).length === 0) return;
        const btn = document.querySelector(".btn-checkout");
        const oldHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';
        const u = JSON.parse(localStorage.getItem("nizami_user"));
        document.getElementById("struk-mitra").innerText =
          "Mitra: " + (u ? u.nama : "-");
        document.getElementById("struk-date").innerText =
          new Date().toLocaleString("id-ID");
        const ic = document.getElementById("struk-items");
        ic.innerHTML = "";
        let totalRp = 0;
        for (let id in batchCart) {
          let item = batchCart[id];
          let sub = item.qty * item.harga;
          totalRp += sub;
          let prev = item.currentDone;
          let curr = prev + item.qty;
          let tglText = item.date || "";
          ic.insertAdjacentHTML(
            "beforeend",
            `<div style="font-size: 11px; border-bottom: 1px dashed #ccc; padding-bottom: 5px; margin-bottom: 5px;"><div style="display:flex; justify-content:space-between;"><span style="font-weight:bold; font-size:12px;">${item.nama}</span><span style="font-size:9px; color:#666;">${tglText}</span></div><div style="display:flex; justify-content:space-between; margin-top:3px; color:#333;"><div style="width:40%; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">${item.paket}</div><div style="width:30%; text-align:center;">(${prev} âž” ${curr})</div><div style="width:10%; text-align:center;">+${item.qty}</div><div style="width:20%; text-align:right; font-weight:bold;">${sub.toLocaleString("id-ID")}</div></div></div>`,
          );
        }
        document.getElementById("struk-total-val").innerText =
          "Rp " + totalRp.toLocaleString("id-ID");
        const wrapper = document.getElementById("struk-area");
        wrapper.style.left = "0px";
        wrapper.style.zIndex = "-1";
        setTimeout(() => {
          html2canvas(wrapper, { scale: 2 }).then((c) => {
            base64StrukImg = c.toDataURL("image/jpeg", 0.9);
            document.getElementById("preview-img-container").innerHTML =
              `<img src="${base64StrukImg}">`;
            wrapper.style.left = "-9999px";
            document.getElementById("modalPreviewImg").classList.add("show");
            btn.innerHTML = oldHtml;
          });
        }, 100);
      }
      function tutupPreviewImg() {
        document.getElementById("modalPreviewImg").classList.remove("show");
      }
      function downloadStruk() {
        if (!base64StrukImg) return;
        const a = document.createElement("a");
        a.href = base64StrukImg;
        a.download = `Rekap_Mitra_${new Date().getTime()}.jpg`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
      }
      function kirimWaAdmin() {
        const u = JSON.parse(localStorage.getItem("nizami_user"));
        let t = 0;
        for (let k in batchCart) {
          t += batchCart[k].qty * batchCart[k].harga;
        }
        let msg = `*LAPORAN SETORAN HARIAN*\\nMitra: ${u ? u.nama : "-"}\\nTotal Setor: Rp ${t.toLocaleString("id-ID")}\\n\\nStruk rincian terlampir (Silakan kirim gambar struk secara manual).`;
        window.open(
          `https://wa.me/628122261036?text=${encodeURIComponent(msg)}`,
        );
        batchCart = {};
        localStorage.removeItem("mitra_draft_" + userId);
        document
          .querySelectorAll(".stepper-input")
          .forEach((inp) => (inp.value = 0));
        updateBatchUI();
        tutupPreviewImg();
        document.getElementById("batchBar").classList.remove("expanded");
      }

      // ==========================================
      // LOGIKA PENDAFTARAN PESERTA (MANDIRI MULTI-PAKET & AUTO-FILL)
      // ==========================================
      function bukaModalDaftarBaru() {
        document.getElementById("formsContainerMitra").innerHTML = "";
        formCountMitra = 0;
        rowDataMitra = {};
        addParticipantRowMitra();
        document.getElementById("modalDaftarBaru").classList.add("show");
      }

      function tutupModalDaftarBaru() {
        document.getElementById("modalDaftarBaru").classList.remove("show");
      }

      function addParticipantRowMitra() {
        formCountMitra++;
        const id = formCountMitra;
        rowDataMitra[`row_${id}`] = { packages: [] };

        let optHtml =
          '<option value="" disabled selected>-- Pilih Jenis Paket --</option>';
        masterPaket.forEach((p) => {
          optHtml += `<option value="${p.nama}">${p.nama}</option>`;
        });

        // AUTO FILL LANGSUNG DARI VARIABLE GLOBAL YANG DITARIK DARI DATABASE
        let defHp =
          globalMitraHp || localStorage.getItem("mitra_hp_cache") || "";
        let defAlamat =
          globalMitraAlamat || localStorage.getItem("mitra_alamat_cache") || "";

        const html = `
        <div class="peserta-card" id="rowMitra_${id}" style="margin-bottom:20px; border:1px solid #333;">
            <div style="display:flex; justify-content:space-between; margin-bottom:12px; align-items:center;">
                <b style="color:#ffd700; font-size:1.1rem;"><i class="fas fa-user"></i> Peserta #${id}</b>
                ${id > 1 ? `<button type="button" style="background:none; border:none; color:#ff6b6b; cursor:pointer;" onclick="removeRowMitra(${id})"><i class="fas fa-trash"></i> Batal</button>` : ""}
            </div>
            
            <input type="text" id="regNama_${id}" class="input-dark" style="margin-bottom:8px;" placeholder="Nama Lengkap" required />
            <input type="tel" id="regHP_${id}" class="input-dark" style="margin-bottom:8px;" placeholder="No. WhatsApp" value="${defHp}" required />
            <textarea id="regAlamat_${id}" class="input-dark" style="margin-bottom:12px;" placeholder="Alamat Lengkap" rows="2" required>${defAlamat}</textarea>

            <div style="background: #1a1a1a; padding: 10px; border-radius: 8px; border: 1px dashed #444; margin-bottom: 10px;">
                <label class="cs-label" style="color: #ffd700; font-weight: bold; margin-bottom:5px;">Tambahkan Paket:</label>
                <div style="display:flex; gap:8px;">
                    <select id="regPaketSel_${id}" class="cs-select" style="margin-bottom:0;">
                        ${optHtml}
                    </select>
                    <button type="button" onclick="addPaketToRow(${id})" style="background:#4ade80; color:#000; border:none; border-radius:8px; padding:0 15px; font-weight:bold; cursor:pointer; flex-shrink:0;"><i class="fas fa-plus"></i></button>
                </div>
            </div>

            <div id="paketListContainer_${id}" style="margin-bottom:10px;">
                <div style="text-align: center; color: #555; font-size: 0.8rem; padding: 10px; border: 1px dashed #333; border-radius:8px;">Belum ada paket ditambahkan. Pilih lalu tekan <i class="fas fa-plus"></i></div>
            </div>
            
            <div style="text-align: right; font-weight: bold; color: #fff; margin-bottom: 5px; border-top: 1px dashed #333; padding-top: 10px;">
                Total Setoran Awal:
                <div id="regTotal_${id}" style="color: #ffd700; font-size: 1.1rem">Rp 0</div>
            </div>
        </div>`;
        document
          .getElementById("formsContainerMitra")
          .insertAdjacentHTML("beforeend", html);
      }

      function removeRowMitra(id) {
        document.getElementById(`rowMitra_${id}`).remove();
        delete rowDataMitra[`row_${id}`];
      }

      function addPaketToRow(rowId) {
        const sel = document.getElementById(`regPaketSel_${rowId}`);
        if (!sel.value)
          return alert("Pilih paket dari daftar terlebih dahulu!");

        const pktName = sel.options[sel.selectedIndex].text;
        const valLower = pktName.toLowerCase();

        let mode = "normal";
        if (valLower.includes("mingguan")) mode = "mingguan";
        else if (valLower.includes("cookies") || valLower.includes("kue"))
          mode = "cookies";

        const pkgId = "pkg_" + Date.now() + Math.floor(Math.random() * 1000);

        rowDataMitra[`row_${rowId}`].packages.push({
          id: pkgId,
          name: pktName,
          mode: mode,
          items: {},
        });

        renderPaketList(rowId);
      }

      function removePaketFromRow(rowId, pkgId) {
        const arr = rowDataMitra[`row_${rowId}`].packages;
        rowDataMitra[`row_${rowId}`].packages = arr.filter(
          (p) => p.id !== pkgId,
        );
        renderPaketList(rowId);
      }

      function renderPaketList(rowId) {
        const container = document.getElementById(
          `paketListContainer_${rowId}`,
        );
        const pkgs = rowDataMitra[`row_${rowId}`].packages;

        if (pkgs.length === 0) {
          container.innerHTML = `<div style="text-align: center; color: #555; font-size: 0.8rem; padding: 10px; border: 1px dashed #333; border-radius:8px;">Belum ada paket ditambahkan. Pilih lalu tekan <i class="fas fa-plus"></i></div>`;
          document.getElementById(`regTotal_${rowId}`).innerHTML = "Rp 0";
          return;
        }

        let html = "";
        let grandTotalDisplay = 0;

        pkgs.forEach((pkg) => {
          let btnBarangHtml = "";
          let rincianHtml = "";

          let totalSetoranPkg = 0;
          let txtSetoran = "";

          let itemKeys = Object.keys(pkg.items);
          if (itemKeys.length > 0) {
            let rincianArr = [];
            itemKeys.forEach((k) => {
              let qty = pkg.items[k];
              let b = masterBarang.find((mb) => mb.nama === k);
              if (b) {
                let sub = b.harga * qty;
                if (pkg.mode === "mingguan")
                  sub = Math.ceil(b.harga / 40) * qty;
                else if (pkg.mode === "cookies")
                  sub = Math.ceil(b.harga / 330) * qty;
                totalSetoranPkg += sub;
                rincianArr.push(`${qty}x ${k}`);
              }
            });

            rincianHtml = `<div style="font-size:0.75rem; color:#aaa; margin-top:10px; padding:8px; background:#000; border-radius:4px; border:1px dashed #333;">${rincianArr.join("<br>")}</div>`;

            if (pkg.mode === "mingguan")
              txtSetoran = `Rp ${totalSetoranPkg.toLocaleString("id-ID")} /mgg`;
            else if (pkg.mode === "cookies")
              txtSetoran = `Rp ${totalSetoranPkg.toLocaleString("id-ID")} /hari`;
            else txtSetoran = `(Aturan Dasar Paket)`;
          } else {
            txtSetoran = `Rp 0`;
            if (pkg.mode === "normal") txtSetoran = `(Aturan Dasar Paket)`;
          }

          grandTotalDisplay += totalSetoranPkg;

          if (pkg.mode === "mingguan") {
            btnBarangHtml = `<button type="button" class="btn-pilih-barang" style="margin-top:10px; margin-bottom:0;" onclick="bukaPilihBarangMitra(${rowId}, '${pkg.id}')"><i class="fas fa-shopping-basket"></i> Pilih Sembako</button>`;
          } else if (pkg.mode === "cookies") {
            btnBarangHtml = `<button type="button" class="btn-pilih-barang" style="margin-top:10px; margin-bottom:0;" onclick="bukaPilihBarangMitra(${rowId}, '${pkg.id}')"><i class="fas fa-cookie-bite"></i> Pilih Kue</button>`;
          } else {
            btnBarangHtml = `<button type="button" class="btn-pilih-barang" style="margin-top:10px; margin-bottom:0; background:transparent; color:#aaa; border-color:#444;" onclick="bukaPilihBarangMitra(${rowId}, '${pkg.id}')"><i class="fas fa-edit"></i> Request Brg (Opsional)</button>`;
          }

          html += `
              <div style="background:#1a1a1a; border:1px solid #333; padding:15px; border-radius:12px; margin-bottom:15px; position:relative;">
                  <i class="fas fa-trash-alt" onclick="removePaketFromRow(${rowId}, '${pkg.id}')" style="position:absolute; top:15px; right:15px; color:#ff4d4d; cursor:pointer; font-size:1.1rem; padding:5px;"></i>
                  
                  <div style="font-weight:bold; color:#ffd700; font-size:1rem; margin-bottom:10px; padding-right:30px;">
                      <i class="fas fa-box"></i> ${pkg.name}
                  </div>
                  
                  ${rincianHtml}
                  ${btnBarangHtml}
                  
                  <div style="text-align:right; margin-top:10px; border-top:1px dashed #444; padding-top:10px;">
                      <span style="font-size:0.8rem; color:#aaa;">Target Setoran:</span><br>
                      <span style="font-size:1.1rem; color:#4ade80; font-weight:bold;">${txtSetoran}</span>
                  </div>
              </div>`;
        });

        container.innerHTML = html;
        document.getElementById(`regTotal_${rowId}`).innerHTML =
          `Rp ${grandTotalDisplay.toLocaleString("id-ID")}`;
      }

      // ==== FUNGSI PENGATUR MODAL ====
      function bukaPilihBarangMitra(rowId, pkgId) {
        currentEditingRowIdMitra = rowId;
        currentEditingPkgIdMitra = pkgId;

        const pkg = rowDataMitra[`row_${rowId}`].packages.find(
          (p) => p.id === pkgId,
        );
        const mode = pkg.mode;

        document.getElementById("modalPilihBarang").classList.add("show");

        if (mode === "cookies") renderCookiesOnly();
        else renderCatMitraAccordion();
      }

      function tutupPilihBarang() {
        document.getElementById("modalPilihBarang").classList.remove("show");
      }

      // ==== FUNGSI RENDER SPESIFIK UNTUK COOKIES ====
      function renderCookiesOnly() {
        const body = document.getElementById("pbBody");
        document.getElementById("pbTitle").innerHTML =
          `<i class="fas fa-cookie-bite"></i> Pilih Cookies`;
        const pkg = rowDataMitra[
          `row_${currentEditingRowIdMitra}`
        ].packages.find((p) => p.id === currentEditingPkgIdMitra);

        let html = `<div style="height: 15px;"></div><div style="background:rgba(255, 215, 0, 0.1); border:1px solid rgba(255, 215, 0, 0.3); color:#ffd700; padding:10px; border-radius:8px; margin-bottom:15px; font-size:0.8rem; text-align:center;">
            <i class="fas fa-exclamation-circle"></i> <b>Wajib Tepat 5 Toples!</b> Anda harus memilih tepat 5 item untuk melanjutkan.
        </div>`;

        masterBarang.forEach((b) => {
          if (b.kategori && b.kategori.toLowerCase().trim() === "cookies") {
            const qty = pkg.items[b.nama] || 0;
            let displayPrice = Math.ceil(b.harga / 330);
            html += generateItemRowHTML(b, displayPrice, "hari", qty);
          }
        });
        body.innerHTML = html;
        updatePilihBarangTotalMitra();
      }

      // ==== FUNGSI RENDER ACCORDION UNTUK MINGGUAN & NORMAL ====
      function renderCatMitraAccordion() {
        const body = document.getElementById("pbBody");
        document.getElementById("pbTitle").innerHTML =
          `<i class="fas fa-box-open"></i> Pilih Barang`;

        const pkg = rowDataMitra[
          `row_${currentEditingRowIdMitra}`
        ].packages.find((p) => p.id === currentEditingPkgIdMitra);
        const mode = pkg.mode;

        const categories = [
          ...new Set(masterBarang.map((item) => item.kategori)),
        ];
        let html = `<div style="height: 15px;"></div>`;

        categories.forEach((cat) => {
          if (!cat) return;
          let cLow = cat.toLowerCase();

          if (cLow.includes("wadah")) return;

          if (mode === "mingguan") {
            if (
              cLow === "sembako 2" ||
              cLow === "mie 2" ||
              cLow.includes("kerupuk") ||
              cLow.includes("bumbu")
            )
              return;
            if (
              cLow.includes("cookie") ||
              cLow.includes("kids") ||
              cLow.includes("snack")
            )
              return;
            if (
              cLow.includes("kue") &&
              !(cLow.includes("kue kaleng") || cLow.includes("kue balbalan"))
            )
              return;
          }

          let catId = cat.replace(/\s+/g, "_").replace(/[^a-zA-Z0-9_]/g, "");

          html += `
          <div class="accordion-header" onclick="toggleAccordion('${catId}')">
              <span><i class="fas fa-tag" style="margin-right:8px; opacity:0.7;"></i> ${cat}</span>
              <i class="fas fa-chevron-down" id="icon_${catId}"></i>
          </div>
          <div class="accordion-body" id="body_${catId}" style="display:none;">
          `;

          masterBarang.forEach((b) => {
            if (b.kategori === cat) {
              const qty = pkg.items[b.nama] || 0;
              let displayPrice = b.harga;
              let labelSatuan = b.satuan;

              if (mode === "mingguan") {
                displayPrice = Math.ceil(b.harga / 40);
                labelSatuan = "minggu";
              }
              html += generateItemRowHTML(b, displayPrice, labelSatuan, qty);
            }
          });
          html += `</div>`;
        });

        body.innerHTML = html;
        updatePilihBarangTotalMitra();
      }

      function generateItemRowHTML(b, displayPrice, labelSatuan, qty) {
        let safeName = b.nama.replace(/'/g, "\\'");
        let inputId = `pb_qty_${b.nama.replace(/[\s\W]/g, "")}`;
        return `
            <div style="display:flex; justify-content:space-between; align-items:center; padding:12px 0; border-bottom:1px solid #222;">
                <div style="flex:1; padding-right:10px;">
                    <div style="font-weight:bold; color:#fff; font-size:0.9rem;">${b.nama}</div>
                    <div style="font-size:0.75rem; color:#aaa;">Rp ${displayPrice.toLocaleString("id-ID")} / ${labelSatuan}</div>
                </div>
                <div class="stepper-control">
                    <button type="button" class="stepper-btn" onclick="changeQtyMitra('${safeName}', -1)">-</button>
                    <input type="number" readonly class="stepper-input" id="${inputId}" value="${qty}">
                    <button type="button" class="stepper-btn" onclick="changeQtyMitra('${safeName}', 1)">+</button>
                </div>
            </div>`;
      }

      function toggleAccordion(catId) {
        const body = document.getElementById(`body_${catId}`);
        const icon = document.getElementById(`icon_${catId}`);

        if (body.style.display === "none") {
          body.style.display = "block";
          icon.classList.replace("fa-chevron-down", "fa-chevron-up");
        } else {
          body.style.display = "none";
          icon.classList.replace("fa-chevron-up", "fa-chevron-down");
        }
      }

      function changeQtyMitra(nama, change) {
        const pkg = rowDataMitra[
          `row_${currentEditingRowIdMitra}`
        ].packages.find((p) => p.id === currentEditingPkgIdMitra);
        const mode = pkg.mode;

        let currentTotalQty = 0;
        for (let k in pkg.items) {
          currentTotalQty += pkg.items[k];
        }

        let current = pkg.items[nama] || 0;

        if (mode === "cookies" && change > 0 && currentTotalQty >= 5) {
          alert("Paket Cookies maksimal hanya boleh memilih 5 toples.");
          return;
        }

        current += change;
        if (current < 0) current = 0;

        if (current === 0) delete pkg.items[nama];
        else pkg.items[nama] = current;

        document.getElementById(`pb_qty_${nama.replace(/[\s\W]/g, "")}`).value =
          current;
        updatePilihBarangTotalMitra();
      }

      function updatePilihBarangTotalMitra() {
        const pkg = rowDataMitra[
          `row_${currentEditingRowIdMitra}`
        ].packages.find((p) => p.id === currentEditingPkgIdMitra);
        const mode = pkg.mode;

        let total = 0;
        let lblTxt = "Total Nilai Barang";
        let selectedItemsHtml = "";
        let totalQtyCookies = 0;

        for (let key in pkg.items) {
          let item = masterBarang.find((b) => b.nama === key);
          let qty = pkg.items[key];

          if (item && qty > 0) {
            let displayPrice = item.harga;
            totalQtyCookies += qty;

            if (mode === "mingguan") {
              let perMgg = Math.ceil(item.harga / 40);
              total += perMgg * qty;
              lblTxt = "Total Setoran Per Minggu";
              displayPrice = perMgg;
            } else if (mode === "cookies") {
              let perHari = Math.ceil(item.harga / 330);
              total += perHari * qty;
              lblTxt = "Total Setoran Per Hari";
              displayPrice = perHari;
            } else {
              total += item.harga * qty;
            }

            let subtotal = displayPrice * qty;
            selectedItemsHtml += `
                <div style="display:flex; justify-content:space-between; margin-bottom: 4px; border-bottom: 1px dotted #333; padding-bottom: 2px;">
                    <span style="flex:1; padding-right:10px; font-size:0.75rem; color:#ccc;">${qty}x ${item.nama}</span>
                    <span style="color:#ffd700; font-size:0.75rem; font-weight:bold;">Rp ${subtotal.toLocaleString("id-ID")}</span>
                </div>
              `;
          }
        }

        document.getElementById("pbTotalLabel").innerText = lblTxt;

        if (mode === "cookies") {
          document.getElementById("pbTotal").innerHTML =
            `Rp ${total.toLocaleString("id-ID")} <br><span style="font-size:0.7rem; color:${totalQtyCookies === 5 ? "#4ade80" : "#ff6b6b"}">(${totalQtyCookies}/5 Toples)</span>`;
        } else {
          document.getElementById("pbTotal").innerText =
            "Rp " + total.toLocaleString("id-ID");
        }

        const summaryDiv = document.getElementById("pbSelectedItems");
        if (selectedItemsHtml !== "") {
          summaryDiv.innerHTML =
            `<div style="font-size:0.7rem; color:#4ade80; margin-bottom:6px; font-weight:bold;">Telah Dipilih:</div>` +
            selectedItemsHtml;
          summaryDiv.style.display = "block";
        } else {
          summaryDiv.innerHTML = "";
          summaryDiv.style.display = "none";
        }
      }

      function selesaiPilihBarang() {
        const pkg = rowDataMitra[
          `row_${currentEditingRowIdMitra}`
        ].packages.find((p) => p.id === currentEditingPkgIdMitra);

        if (pkg.mode === "cookies") {
          let totalQty = 0;
          for (let k in pkg.items) totalQty += pkg.items[k];
          if (totalQty !== 5) {
            alert(
              `Paket Cookies harus memilih TEPAT 5 toples. Saat ini Anda baru memilih ${totalQty} toples.`,
            );
            return;
          }
        }

        tutupPilihBarang();
        renderPaketList(currentEditingRowIdMitra);
      }

      function submitDaftarPesertaWA(e) {
        e.preventDefault();
        const mitra = document.getElementById("mitraName").innerText;
        let msg = `Halo Admin, saya Mitra *${mitra}* ingin mendaftarkan *PESERTA BARU*.\\n\\n`;
        let validCount = 0;

        for (let i = 1; i <= formCountMitra; i++) {
          if (!document.getElementById(`rowMitra_${i}`)) continue;

          const n = document.getElementById(`regNama_${i}`).value.trim();
          const h = document.getElementById(`regHP_${i}`).value.trim();
          const a = document.getElementById(`regAlamat_${i}`).value.trim();

          if (!n || !h) {
            alert(
              `Pendaftaran gagal! Harap lengkapi Nama dan No WhatsApp pada Peserta #${i}`,
            );
            return;
          }

          const pkgs = rowDataMitra[`row_${i}`].packages;
          if (pkgs.length === 0) {
            alert(
              `Pendaftaran gagal! Harap tambahkan minimal 1 jenis paket untuk Peserta #${i} menggunakan tombol +`,
            );
            return;
          }

          // Validasi Lapis ke-2
          for (let pkg of pkgs) {
            if (pkg.mode === "cookies") {
              let checkQty = 0;
              for (let k in pkg.items) checkQty += pkg.items[k];
              if (checkQty !== 5) {
                alert(
                  `Pendaftaran gagal! Pada Peserta #${i}, ${pkg.name} wajib memilih TEPAT 5 toples.`,
                );
                return;
              }
            }
          }

          validCount++;
          msg += `*ðŸ‘¤ DATA PESERTA ${validCount}*\\n`;
          msg += `Nama: ${n}\\nWA: ${h}\\nAlamat: ${a}\\n\\n`;
          msg += `*ðŸ“¦ PAKET YANG DIAMBIL:*\\n\\n`;

          pkgs.forEach((pkg, pIdx) => {
            msg += `*${pIdx + 1}. ${pkg.name}*\\n`;

            if (Object.keys(pkg.items).length > 0) {
              msg += `ðŸ›’ Rincian Barang:\\n`;
              let pkgTotalSetoran = 0;
              let pkgTotalAsli = 0;

              for (let key in pkg.items) {
                let qty = pkg.items[key];
                let b = masterBarang.find((item) => item.nama === key);
                if (b) {
                  msg += `   - ${qty}x ${key}\\n`;
                  pkgTotalAsli += b.harga * qty;
                  if (pkg.mode === "mingguan")
                    pkgTotalSetoran += Math.ceil(b.harga / 40) * qty;
                  else if (pkg.mode === "cookies")
                    pkgTotalSetoran += Math.ceil(b.harga / 330) * qty;
                  else pkgTotalSetoran += b.harga * qty;
                }
              }

              let txtTarget = "";
              if (pkg.mode === "mingguan")
                txtTarget = `Rp ${pkgTotalSetoran.toLocaleString("id-ID")} /minggu`;
              else if (pkg.mode === "cookies")
                txtTarget = `Rp ${pkgTotalSetoran.toLocaleString("id-ID")} /hari`;
              else txtTarget = `Sesuai Aturan Dasar`;

              msg += `Total Nilai Barang: Rp ${pkgTotalAsli.toLocaleString("id-ID")}\\n`;
              msg += `ðŸŽ¯ *Target Setoran:* ${txtTarget}\\n\\n`;
            } else {
              msg += `ðŸŽ¯ *Target Setoran:* Mengikuti Aturan Dasar Paket\\n\\n`;
            }
          });
          msg += `---------------------------\\n\\n`;
        }

        if (validCount === 0) {
          alert("Tidak ada data peserta untuk didaftarkan!");
          return;
        }

        msg += `Mohon dibantu pembuatan akunnya. Terima kasih! ðŸ™`;

        window.open(
          `https://wa.me/628122261036?text=${encodeURIComponent(msg)}`,
          "_blank",
        );
        tutupModalDaftarBaru();
      }

      function logoutMitra() {
        if (confirm("Yakin ingin keluar?")) {
          localStorage.removeItem("nizami_user");
          window.location.href = "index.html";
        }
      }
      function showToast(msg) {
        let toast = document.getElementById("toast");
        document.getElementById("toastMsg").innerText = msg;
        toast.style.display = "flex";
        setTimeout(() => (toast.style.opacity = "1"), 10);
        setTimeout(() => {
          toast.style.opacity = "0";
          setTimeout(() => (toast.style.display = "none"), 300);
        }, 2000);
      }
    </script>
  </body>
</html>
