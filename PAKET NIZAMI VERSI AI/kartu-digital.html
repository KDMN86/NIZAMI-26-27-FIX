<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>Kartu Tabungan Digital - Nizami</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <style>
      * {
        box-sizing: border-box;
      }
      body {
        background-color: #071a10;
        color: #fff;
        font-family: "Poppins", sans-serif;
        margin: 0;
        padding-bottom: 30px;
      }

      /* HEADER & CATALOG LOGO */
      header {
        padding: 15px 20px;
        position: sticky;
        top: 0;
        z-index: 50;
        background: rgba(7, 26, 16, 0.95);
        backdrop-filter: blur(10px);
        border-bottom: 1px solid #113320;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .header-text {
        display: flex;
        flex-direction: column;
      }
      .title {
        color: #ffd700;
        margin: 0;
        font-size: 1.1rem;
        font-weight: 800;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      .subtitle {
        font-size: 0.7rem;
        color: #aaa;
        margin-top: 2px;
      }

      .katalog-btn {
        background: rgba(255, 215, 0, 0.1);
        color: #ffd700;
        width: 45px;
        height: 45px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        font-size: 1.3rem;
        border: 1px solid rgba(255, 215, 0, 0.3);
        animation: pulseLogo 2s infinite;
      }

      .container {
        padding: 20px;
        max-width: 500px;
        margin: 0 auto;
      }

      /* MULTI-PAKET SELECTOR */
      .paket-selector {
        background: #111;
        border: 1px solid #333;
        padding: 15px;
        border-radius: 12px;
        margin-bottom: 20px;
        display: none;
      }
      .ps-label {
        font-size: 0.8rem;
        color: #aaa;
        margin-bottom: 8px;
        display: block;
      }
      .ps-select {
        width: 100%;
        padding: 10px;
        background: #222;
        color: #fff;
        border: 1px solid #444;
        border-radius: 8px;
        font-family: "Poppins";
        font-weight: bold;
        outline: none;
      }

      /* KARTU EMAS NIZAMI (Tanpa Saldo) */
      .card-container {
        margin-bottom: 20px;
        perspective: 1000px;
      }
      .member-card-box {
        background: linear-gradient(
          135deg,
          #ffd700 0%,
          #fdb931 50%,
          #b8860b 100%
        );
        color: #000;
        padding: 25px;
        border-radius: 20px;
        box-shadow: 0 15px 35px rgba(255, 215, 0, 0.2);
        position: relative;
        overflow: hidden;
        border: 1px solid #ffeda6;
        animation: slideDown 0.5s ease-out;
      }
      .member-card-box::after {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-image: radial-gradient(
          circle,
          rgba(0, 0, 0, 0.05) 1px,
          transparent 1px
        );
        background-size: 10px 10px;
        pointer-events: none;
      }
      .mc-top {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 15px;
      }
      .chip-sim {
        width: 45px;
        height: 32px;
        background: linear-gradient(135deg, #ddd, #aaa);
        border-radius: 6px;
        border: 1px solid #888;
        position: relative;
      }
      .chip-sim::before {
        content: "";
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 1px;
        background: #888;
      }
      .chip-sim::after {
        content: "";
        position: absolute;
        top: 0;
        bottom: 0;
        left: 33%;
        width: 33%;
        border-left: 1px solid #888;
        border-right: 1px solid #888;
      }

      .mc-label {
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        opacity: 0.8;
        font-weight: 700;
      }
      .mc-paket {
        background: rgba(0, 0, 0, 0.1);
        padding: 5px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 800;
        display: inline-block;
        border: 1px solid rgba(0, 0, 0, 0.2);
        margin-top: 5px;
      }

      .mc-footer {
        display: flex;
        justify-content: space-between;
        align-items: flex-end;
        margin-top: 30px;
      }
      .mc-name {
        font-weight: 800;
        font-size: 1.1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
      }
      .mc-id {
        font-family: monospace;
        font-size: 1rem;
        font-weight: 700;
        opacity: 0.8;
        background: rgba(255, 255, 255, 0.3);
        padding: 3px 8px;
        border-radius: 6px;
      }

      /* TOMBOL RINCIAN BARANG DI BAWAH KARTU */
      .btn-rincian {
        width: 100%;
        background: #1a1a1a;
        color: #ffd700;
        border: 1px solid #333;
        padding: 12px;
        border-radius: 12px;
        font-weight: bold;
        cursor: pointer;
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 8px;
        margin-bottom: 25px;
        transition: 0.2s;
      }
      .btn-rincian:active {
        background: #333;
      }

      /* STATS SINGKAT */
      .stats-box {
        background: #111;
        border: 1px solid #222;
        border-radius: 15px;
        padding: 15px;
        display: flex;
        justify-content: space-around;
        margin-bottom: 25px;
        text-align: center;
      }
      .sb-item {
        display: flex;
        flex-direction: column;
      }
      .sb-val {
        font-size: 1.4rem;
        font-weight: 800;
        color: #4ade80;
      }
      .sb-label {
        font-size: 0.7rem;
        color: #888;
        text-transform: uppercase;
        margin-top: 4px;
      }

      /* KALENDER */
      .section-title {
        font-size: 1rem;
        color: #fff;
        margin-bottom: 15px;
        font-weight: bold;
        border-left: 3px solid #ffd700;
        padding-left: 10px;
      }
      .legend-box {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
        font-size: 0.7rem;
        color: #aaa;
      }
      .lg-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }
      .lg-box {
        width: 14px;
        height: 14px;
        border-radius: 3px;
      }
      .lg-b-done {
        background: #4ade80;
      }
      .lg-u-done {
        background: #ffd700;
      }
      .lg-b-pend {
        border: 1px solid #4ade80;
      }
      .lg-u-pend {
        border: 1px solid #ffd700;
      }
      .month-card {
        background: #111;
        border-radius: 16px;
        padding: 15px;
        border: 1px solid #222;
        margin-bottom: 20px;
      }
      .month-title {
        text-align: center;
        color: #48dbfb;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 0.9rem;
        letter-spacing: 1px;
        text-transform: uppercase;
      }
      .cal-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 6px;
      }
      .cal-head {
        text-align: center;
        font-size: 0.7rem;
        color: #888;
        font-weight: 600;
        padding-bottom: 8px;
      }
      .cal-cell {
        aspect-ratio: 1/1;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.85rem;
        font-weight: bold;
        border-radius: 6px;
      }
      .cal-cell.empty {
        background: transparent;
      }
      .cal-grid-weekly {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 10px;
      }
      .weekly-cell {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 10px 5px;
        border-radius: 8px;
        text-align: center;
      }
      .w-tgl {
        font-size: 0.65rem;
        opacity: 0.8;
        margin-bottom: 4px;
      }
      .w-mg {
        font-size: 0.95rem;
        font-weight: bold;
      }
      .done-barang {
        background: #4ade80;
        color: #000;
        box-shadow: 0 0 8px rgba(74, 222, 128, 0.4);
      }
      .done-uang {
        background: #ffd700;
        color: #000;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.4);
      }
      .pend-barang {
        border: 1px solid #2b5c3b;
        color: #4ade80;
        background: #0a1f12;
      }
      .pend-uang {
        border: 1px solid #665600;
        color: #ffd700;
        background: #1f1a00;
      }

      /* MODAL RINCIAN BARANG */
      #modalBarang {
        display: none;
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.9);
        z-index: 100;
        align-items: center;
        justify-content: center;
        padding: 20px;
        backdrop-filter: blur(5px);
      }
      .modal-card {
        background: #1e1e1e;
        width: 100%;
        max-width: 400px;
        border-radius: 16px;
        border: 1px solid #444;
        overflow: hidden;
        animation: slideDown 0.3s ease;
      }
      .modal-header {
        background: #111;
        padding: 15px 20px;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .modal-body {
        padding: 20px;
        max-height: 60vh;
        overflow-y: auto;
        line-height: 1.6;
        color: #ccc;
        font-size: 0.9rem;
      }
      .btn-close {
        background: none;
        border: none;
        color: #aaa;
        font-size: 1.5rem;
        cursor: pointer;
      }

      /* FORM PENCARIAN */
      .search-box {
        background: #111;
        padding: 25px;
        border-radius: 16px;
        border: 1px solid #333;
        text-align: center;
      }
      .s-input {
        width: 100%;
        padding: 15px;
        background: #222;
        border: 1px solid #444;
        color: #fff;
        border-radius: 10px;
        font-size: 1rem;
        text-align: center;
        margin-bottom: 15px;
        outline: none;
      }
      .s-input:focus {
        border-color: #ffd700;
      }
      .s-btn {
        background: #ffd700;
        color: #000;
        width: 100%;
        padding: 15px;
        border: none;
        border-radius: 10px;
        font-weight: bold;
        cursor: pointer;
        font-size: 1rem;
      }

      .loader {
        text-align: center;
        padding: 50px 20px;
        color: #ffd700;
      }

      @keyframes slideDown {
        from {
          opacity: 0;
          transform: translateY(-30px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      @keyframes pulseLogo {
        0% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0.4);
        }
        70% {
          box-shadow: 0 0 0 10px rgba(255, 215, 0, 0);
        }
        100% {
          box-shadow: 0 0 0 0 rgba(255, 215, 0, 0);
        }
      }
    </style>
  </head>
  <body>
    <header>
      <div class="header-text">
        <h1 class="title">Kartu Setoran</h1>
        <div class="subtitle">NIZAMI 2026-2027</div>
      </div>
      <a href="index.html" class="katalog-btn" title="Lihat Katalog Promo">
        <i class="fas fa-store"></i>
      </a>
    </header>

    <div class="container" id="main-content">
      <div class="loader">
        <i class="fas fa-circle-notch fa-spin fa-3x"></i>
        <p style="font-size: 0.9rem; margin-top: 15px; color: #aaa">
          Menarik data tabungan Anda...
        </p>
      </div>
    </div>

    <div id="modalBarang">
      <div class="modal-card">
        <div class="modal-header">
          <h3 style="margin: 0; color: #ffd700; font-size: 1.1rem">
            <i class="fas fa-box-open"></i> Isi Paket
          </h3>
          <button
            class="btn-close"
            onclick="
              document.getElementById('modalBarang').style.display = 'none'
            "
          >
            &times;
          </button>
        </div>
        <div class="modal-body" id="listBarangArea">Memuat barang...</div>
      </div>
    </div>

    <script>
      // MASUKKAN URL GOOGLE SCRIPT ADMIN DI SINI
      const scriptURL =
        "https://script.google.com/macros/s/AKfycbwZtX_DYOuaweFSZVo8d--h64RKrrDM-nFqnWVzOc0_aMnpfKRF9h9ocvsMpGfT5Qmt5Q/exec";

      async function fetchData(action, data = {}) {
        try {
          const url = new URL(scriptURL);
          url.searchParams.append("action", action);
          for (let key in data) url.searchParams.append(key, data[key]);
          const response = await fetch(url);
          return await response.json();
        } catch (error) {
          return null;
        }
      }

      const urlParams = new URLSearchParams(window.location.search);
      const paramId = urlParams.get("id");
      let allUserPackages = []; // Menyimpan semua paket milik user

      async function initPage() {
        if (!paramId) {
          document.getElementById("main-content").innerHTML = `
                <div class="search-box">
                    <i class="fas fa-id-card" style="font-size:3rem; color:#ffd700; margin-bottom:15px;"></i>
                    <h3 style="margin-top:0;">Masukkan ID Peserta</h3>
                    <input type="text" id="inputId" class="s-input" placeholder="Contoh: AHMAD-7577">
                    <button class="s-btn" onclick="cariID()">CARI KARTU SAYA</button>
                </div>`;
          return;
        }

        try {
          // GUNAKAN API BARU: getInfoKartu
          const dataUser = await fetchData("getInfoKartu", { id: paramId });

          if (dataUser && !dataUser.error && dataUser.list_paket.length > 0) {
            allUserPackages = dataUser.list_paket;

            // Cari paket yang ID-nya persis sesuai URL, jika tidak ada pakai paket pertama
            let activePaket =
              allUserPackages.find((p) => p.id === paramId) ||
              allUserPackages[0];

            renderBaseUI(dataUser.nama);
            renderCard(activePaket);
          } else {
            throw new Error("Kosong");
          }
        } catch (e) {
          document.getElementById("main-content").innerHTML = `
            <div style="text-align:center; padding:40px 20px;">
                <i class="fas fa-times-circle" style="font-size:3rem; color:#ff6b6b; margin-bottom:15px;"></i>
                <h3>Data Tidak Ditemukan</h3>
                <p style="color:#aaa; font-size:0.85rem;">Pastikan link dari WA sudah benar.</p>
                <button onclick="window.location.href='kartu-digital.html'" style="background:#333; color:#fff; padding:10px 20px; border:none; border-radius:8px; margin-top:15px;">Coba Lagi</button>
            </div>`;
        }
      }

      function cariID() {
        const val = document
          .getElementById("inputId")
          .value.trim()
          .toUpperCase();
        if (val) window.location.href = `kartu-digital.html?id=${val}`;
      }

      function renderBaseUI(namaPemilik) {
        let html = ``;
        // Tampilkan Dropdown Pilihan jika paket > 1
        if (allUserPackages.length > 1) {
          let options = "";
          allUserPackages.forEach((p) => {
            let selected = p.id === paramId ? "selected" : "";
            options += `<option value="${p.id}" ${selected}>${p.paket} (ID: ${p.id})</option>`;
          });
          html += `
              <div class="paket-selector" style="display:block;">
                  <span class="ps-label"><i class="fas fa-layer-group"></i> Anda memiliki ${allUserPackages.length} Paket:</span>
                  <select class="ps-select" onchange="gantiPaket(this.value)">${options}</select>
              </div>`;
        }

        html += `
              <div id="dynamicCardArea"></div>
              <div class="section-title"><i class="fas fa-calendar-check"></i> Kalender Bukti Setoran</div>
              <div class="legend-box">
                  <div class="lg-item"><div class="lg-box lg-b-done"></div> Lunas (Barang)</div>
                  <div class="lg-item"><div class="lg-box lg-u-done"></div> Lunas (Uang)</div>
                  <div class="lg-item"><div class="lg-box lg-b-pend"></div> Belum (Barang)</div>
                  <div class="lg-item"><div class="lg-box lg-u-pend"></div> Belum (Uang)</div>
              </div>
              <div id="calendar-area"></div>
          `;
        document.getElementById("main-content").innerHTML = html;
        window.namaPemilik = namaPemilik;
      }

      function gantiPaket(newId) {
        let selected = allUserPackages.find((p) => p.id === newId);
        if (selected) renderCard(selected);
      }

      function renderCard(paketInfo) {
        const isMingguan = String(paketInfo.paket)
          .toLowerCase()
          .includes("mingguan");
        let tTotal = parseInt(paketInfo.targetTotal) || (isMingguan ? 40 : 330);
        const tBarang =
          parseInt(paketInfo.targetBarang) || (isMingguan ? 40 : 130);
        const setoranMasuk = parseInt(paketInfo.tercapai) || 0;

        // Render Kartu (Tanpa Saldo)
        let htmlCard = `
            <div class="card-container">
                <div class="member-card-box">
                    <div class="mc-top">
                        <div class="chip-sim"></div>
                        <div class="mc-label">Nizami Digital Card</div>
                    </div>
                    
                    <div class="mc-paket">${paketInfo.paket}</div>
                    
                    <div class="mc-footer">
                        <div>
                            <div class="mc-label">Pemilik</div>
                            <div class="mc-name">${window.namaPemilik}</div>
                        </div>
                        <div class="mc-id">${paketInfo.id}</div>
                    </div>
                </div>
            </div>

            <button class="btn-rincian" onclick="lihatRincian('${paketInfo.id}')">
                <i class="fas fa-box-open"></i> Lihat Rincian Isi Paket
            </button>

            <div class="stats-box">
                <div class="sb-item">
                    <span class="sb-val">${setoranMasuk}</span>
                    <span class="sb-label">Sudah Setor</span>
                </div>
                <div style="width:1px; background:#333;"></div>
                <div class="sb-item">
                    <span class="sb-val" style="color:#ffd700;">${tTotal}</span>
                    <span class="sb-label">Total Target</span>
                </div>
                <div style="width:1px; background:#333;"></div>
                <div class="sb-item">
                    <span class="sb-val" style="color:#ff6b6b;">${tTotal - setoranMasuk}</span>
                    <span class="sb-label">Sisa Kali</span>
                </div>
            </div>
        `;
        document.getElementById("dynamicCardArea").innerHTML = htmlCard;

        // Render Kalender
        if (isMingguan) generateWeeklyCalendar(setoranMasuk, tBarang, tTotal);
        else generateDailyCalendar(setoranMasuk, tBarang, tTotal);
      }

      function lihatRincian(paketId) {
        let selected = allUserPackages.find((p) => p.id === paketId);
        let listHtml = "";

        if (selected && selected.rincian.length > 0) {
          listHtml = selected.rincian.join("<br><br>");
        } else {
          listHtml =
            "<i>Belum ada rincian barang spesifik untuk paket ini.</i>";
        }

        document.getElementById("listBarangArea").innerHTML = listHtml;
        document.getElementById("modalBarang").style.display = "flex";
      }

      // --- LOGIKA KALENDER ---
      function generateWeeklyCalendar(setoranMasuk, targetBarang, totalTarget) {
        let html = "";
        let currentDate = new Date(2026, 3, 1, 12, 0, 0);
        let currentMonth = -1;
        let monthHtml = "";
        const namaBulan = [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ];

        for (let i = 1; i <= totalTarget; i++) {
          if (currentDate.getMonth() !== currentMonth) {
            if (currentMonth !== -1) {
              monthHtml += `</div></div>`;
              html += monthHtml;
            }
            currentMonth = currentDate.getMonth();
            let titleBulan = `${namaBulan[currentMonth]} ${currentDate.getFullYear()}`;
            monthHtml = `<div class="month-card"><div class="month-title">${titleBulan}</div><div class="cal-grid-weekly">`;
          }
          let isDone = i <= setoranMasuk;
          let isBarang = i <= targetBarang;
          let cellClass = "weekly-cell ";
          if (isDone) cellClass += isBarang ? "done-barang" : "done-uang";
          else cellClass += isBarang ? "pend-barang" : "pend-uang";
          let tglStr = `${currentDate.getDate()} ${namaBulan[currentMonth].substring(0, 3)}`;
          monthHtml += `<div class="${cellClass}"><div class="w-tgl">${tglStr}</div><div class="w-mg">Mg-${i}</div></div>`;
          currentDate.setDate(currentDate.getDate() + 7);
        }
        if (monthHtml !== "") {
          monthHtml += `</div></div>`;
          html += monthHtml;
        }
        document.getElementById("calendar-area").innerHTML = html;
      }

      function generateDailyCalendar(setoranMasuk, targetBarang, totalTarget) {
        let html = "";
        let currentDate = new Date(2026, 3, 1, 12, 0, 0);
        let currentMonth = -1;
        let monthHtml = "";
        const namaBulan = [
          "JANUARI",
          "FEBRUARI",
          "MARET",
          "APRIL",
          "MEI",
          "JUNI",
          "JULI",
          "AGUSTUS",
          "SEPTEMBER",
          "OKTOBER",
          "NOVEMBER",
          "DESEMBER",
        ];
        const hariArr = ["Mg", "Sn", "Sl", "Rb", "Km", "Jm", "Sb"];

        for (let i = 1; i <= totalTarget; i++) {
          if (currentDate.getMonth() !== currentMonth) {
            if (currentMonth !== -1) {
              monthHtml += `</div></div>`;
              html += monthHtml;
            }
            currentMonth = currentDate.getMonth();
            let titleBulan = `${namaBulan[currentMonth]} ${currentDate.getFullYear()}`;
            monthHtml = `<div class="month-card"><div class="month-title">${titleBulan}</div><div class="cal-grid">`;
            hariArr.forEach((d) => {
              monthHtml += `<div class="cal-head">${d}</div>`;
            });
            let firstDayIndex = currentDate.getDay();
            for (let e = 0; e < firstDayIndex; e++) {
              monthHtml += `<div class="cal-cell empty"></div>`;
            }
          }
          let isDone = i <= setoranMasuk;
          let isBarang = i <= targetBarang;
          let cellClass = "cal-cell ";
          if (isDone) cellClass += isBarang ? "done-barang" : "done-uang";
          else cellClass += isBarang ? "pend-barang" : "pend-uang";
          monthHtml += `<div class="${cellClass}">${currentDate.getDate()}</div>`;
          currentDate.setDate(currentDate.getDate() + 1);
        }
        if (monthHtml !== "") {
          monthHtml += `</div></div>`;
          html += monthHtml;
        }
        document.getElementById("calendar-area").innerHTML = html;
      }

      initPage();
    </script>
  </body>
</html>
