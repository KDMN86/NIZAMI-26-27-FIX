<!doctype html>
<html lang="id">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pilih Paket Cookies - Nizami</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&family=Playball&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      /* 1. SETUP DASAR */
      body {
        background: #1a0505;
        color: #fff;
        font-family: "Poppins", sans-serif;
        padding-bottom: 200px;
        margin: 0;
      }

      /* 2. HEADER */
      header {
        text-align: center;
        padding: 20px;
        background: linear-gradient(to bottom, #2a0a0a, #1a0505);
        position: sticky;
        top: 0;
        z-index: 10;
        box-shadow: 0 5px 20px rgba(0, 0, 0, 0.5);
      }
      h1 {
        font-family: "Playball", cursive;
        font-size: 2rem;
        color: #ffd700;
        margin: 0;
      }
      .header-desc {
        font-size: 0.75rem;
        color: #aaa;
        margin-top: 5px;
      }

      /* 3. INFO KEMASAN */
      .info-banner {
        background: #330a0a;
        border-bottom: 1px solid #551a1a;
        padding: 15px;
        text-align: center;
        box-shadow: 0 5px 15px rgba(255, 215, 0, 0.1);
      }
      .info-banner i {
        color: #ffd700;
        font-size: 1.2rem;
        margin-right: 8px;
      }
      .info-banner span {
        color: #ffd700;
        font-weight: 600;
        font-size: 0.95rem;
      }
      .info-banner small {
        display: block;
        color: #aaa;
        font-size: 0.75rem;
        margin-top: 3px;
      }

      /* 4. GRID PRODUK */
      .cookies-wrapper {
        max-width: 600px;
        margin: 0 auto;
        padding: 15px 10px;
      }

      .cookies-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .cookie-card {
        background: #250b0b;
        border-radius: 15px;
        overflow: hidden;
        border: 1px solid #3d1212;
        transition: 0.2s;
      }
      .cookie-card.selected {
        border-color: #ffd700;
        background: #1d1203;
      }

      /* GAMBAR */
      .img-box {
        width: 100%;
        aspect-ratio: 1 / 1;
        background: #000;
        position: relative;
        cursor: pointer;
      }
      .img-box img {
        width: 100%;
        height: 100%;
        object-fit: cover;
      }
      .zoom-hint {
        position: absolute;
        bottom: 5px;
        right: 5px;
        background: rgba(0, 0, 0, 0.6);
        color: #fff;
        padding: 4px 8px;
        border-radius: 4px;
        font-size: 0.7rem;
        pointer-events: none;
      }

      /* BODY KARTU & CONTROLLER QTY */
      .card-body {
        padding: 10px;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        background: #2a0c0c;
        min-height: 75px;
      }
      .cookie-name {
        font-size: 0.8rem;
        font-weight: 600;
        text-align: center;
        line-height: 1.2;
        margin-bottom: 8px;
      }

      .qty-control {
        display: flex;
        align-items: center;
        justify-content: space-between;
        background: #1a0505;
        padding: 4px;
        border-radius: 50px;
        border: 1px solid #441111;
      }
      .qty-btn {
        width: 28px;
        height: 28px;
        background: #330a0a;
        border: none;
        color: #fff;
        border-radius: 50%;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1rem;
        transition: 0.2s;
      }
      .qty-btn:active {
        transform: scale(0.9);
      }
      .qty-val {
        font-weight: 600;
        width: 20px;
        text-align: center;
        font-size: 0.85rem;
        color: #fff;
      }

      /* 5. FOOTER KERANJANG */
      .cart-drawer {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: rgba(20, 5, 5, 0.98);
        border-top: 1px solid #441111;
        border-radius: 20px 20px 0 0;
        transform: translateY(100%);
        transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
        z-index: 100;
        display: flex;
        flex-direction: column;
      }
      .cart-drawer.show {
        transform: translateY(0);
      }

      .drawer-header {
        padding: 15px 20px;
        border-bottom: 1px solid #330a0a;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      .limit-info {
        font-size: 0.9rem;
        color: #ffd700;
        font-weight: bold;
      }

      .selected-list {
        max-height: 150px;
        overflow-y: auto;
        padding: 15px 20px;
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
      }
      .chip {
        background: #3d1212;
        border: 1px solid #551a1a;
        padding: 6px 14px;
        border-radius: 20px;
        font-size: 0.8rem;
        color: #ddd;
        display: flex;
        align-items: center;
        gap: 6px;
      }
      .chip i {
        cursor: pointer;
        color: #ff6b6b;
        font-size: 1rem;
      }

      .drawer-footer {
        padding: 15px 20px 25px;
        background: #110202;
      }
      .btn-submit {
        background: linear-gradient(90deg, #d4af37, #b8860b);
        color: #000;
        width: 100%;
        padding: 14px;
        border: none;
        border-radius: 50px;
        font-weight: bold;
        font-size: 1rem;
        cursor: pointer;
      }
      .btn-submit:disabled {
        background: #444;
        color: #888;
        cursor: not-allowed;
      }

      /* 6. MODAL ZOOM */
      .zoom-modal {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        z-index: 9999;
        justify-content: center;
        align-items: center;
        flex-direction: column;
      }
      .zoom-modal img {
        width: 100%;
        max-height: 80vh;
        object-fit: contain;
      }
      .close-zoom {
        margin-top: 20px;
        padding: 10px 30px;
        background: transparent;
        border: 1px solid #fff;
        color: #fff;
        border-radius: 50px;
        cursor: pointer;
      }
      .back-btn {
        position: absolute;
        left: 20px;
        top: 25px;
        color: #fff;
        cursor: pointer;
        font-size: 1.2rem;
      }
    </style>
  </head>
  <body>
    <header>
      <i
        class="fas fa-arrow-left back-btn"
        onclick="window.location.href = 'index.html'"
      ></i>
      <h1>Paket Cookies</h1>
      <p class="header-desc">Harga Flat 1000/hari 330x</p>
    </header>

    <div class="info-banner">
      <i class="fas fa-box-open"></i> <span>Kemasan Toples (1000ml)</span>
      <span>/ Kemasan Plastik (500g)</span>
      <small>Boleh campur / pilih yang sama (Maksimal 5 Toples)</small>
    </div>

    <div id="gridWrapper" class="cookies-wrapper">
      <div id="cookiesList" class="cookies-grid">
        <div
          style="
            grid-column: span 2;
            text-align: center;
            color: #666;
            padding: 40px;
          "
        >
          <i class="fas fa-circle-notch fa-spin"></i> Memuat daftar kue...
        </div>
      </div>
    </div>

    <div id="cartDrawer" class="cart-drawer">
      <div class="drawer-header">
        <div class="limit-info" id="limitText">Terpilih: 0 / 5 Toples</div>
        <div style="font-size: 0.7rem; color: #888">Klik (X) untuk hapus</div>
      </div>
      <div id="chipContainer" class="selected-list"></div>
      <div class="drawer-footer">
        <button
          id="btnOrder"
          class="btn-submit"
          onclick="pesanCookies()"
          disabled
        >
          Pesan Sekarang
        </button>
      </div>
    </div>

    <div id="zoomModal" class="zoom-modal" onclick="closeZoom()">
      <img id="zoomImg" src="" alt="Zoom" />
      <button class="close-zoom">Tutup</button>
    </div>

    <script>
      async function fetchData(action, params = {}) {
        const url =
          "https://script.google.com/macros/s/AKfycbzDvfm6gWbv4cOf2yIs5qCWuxusxMbGqepR7BtenGywceGO-7SXo8ympSy_iMnjSvJF6w/exec";
        const queryString = new URLSearchParams({
          action,
          ...params,
        }).toString();
        try {
          const response = await fetch(`${url}?${queryString}`);
          return await response.json();
        } catch (error) {
          console.error("Error:", error);
          return null;
        }
      }

      function kirimWA(nomor, pesan) {
        window.open(`https://wa.me/${nomor}?text=${pesan}`, "_blank");
      }

      // LOGIKA KERANJANG BARU (Menggunakan Kuota / Qty)
      let cart = {}; // Menyimpan format { "Nama Kue": jumlah }
      let totalItems = 0;
      const maxLimit = 5;

      window.onload = async () => {
        const data = await fetchData("getBarang");
        if (data && data.length > 0) {
          const cookiesOnly = data.filter(
            (item) => item.kategori === "Cookies",
          );
          if (cookiesOnly.length > 0) {
            renderCookies(cookiesOnly);
          } else {
            renderCookies(data);
          }
        } else {
          document.getElementById("cookiesList").innerHTML =
            '<div style="grid-column: span 2; text-align: center; color: #ff6b6b; padding: 40px;">Gagal memuat data.</div>';
        }
      };

      function renderCookies(list) {
        const container = document.getElementById("cookiesList");
        container.innerHTML = "";

        list.forEach((item) => {
          if (!item.nama) return;

          const imgName =
            item.nama.toLowerCase().replace(/\s+/g, "-").replace(/\//g, "") +
            ".jpg";
          const imgPath = `image/cookies/${imgName}`;
          const idName = item.nama.replace(/\s+/g, "-");

          // Cek qty saat render ulang (jika ada)
          const currentQty = cart[item.nama] || 0;
          const activeClass = currentQty > 0 ? "selected" : "";

          const div = document.createElement("div");
          div.className = `cookie-card ${activeClass}`;
          div.id = `card-${idName}`;

          div.innerHTML = `
          <div class="img-box" onclick="openZoom('${imgPath}')">
            <img src="${imgPath}" onerror="this.onerror=null; this.parentElement.innerHTML='<i class=\\'fas fa-cookie\\' style=\\'color:#551a1a; font-size:3rem; margin-top:30%;\\'></i>';">
            <div class="zoom-hint"><i class="fas fa-search-plus"></i></div>
          </div>
          <div class="card-body">
            <div class="cookie-name">${item.nama}</div>
            <div class="qty-control">
                <button class="qty-btn" onclick="updateQty('${item.nama}', -1)">-</button>
                <div class="qty-val" id="qty-${idName}">${currentQty}</div>
                <button class="qty-btn" onclick="updateQty('${item.nama}', 1)" style="background:#ffd700; color:#000;">+</button>
            </div>
          </div>
        `;
          container.appendChild(div);
        });
      }

      // Fungsi menambah / mengurangi jumlah kue
      function updateQty(name, change) {
        let currentQty = cart[name] || 0;

        // Mencegah penambahan jika total sudah limit
        if (change > 0 && totalItems >= maxLimit) {
          alert(
            `Maksimal ${maxLimit} toples. Harap kurangi kue lain terlebih dahulu.`,
          );
          return;
        }

        let newQty = currentQty + change;
        if (newQty < 0) newQty = 0; // Tidak boleh minus

        cart[name] = newQty;
        if (newQty === 0) {
          delete cart[name]; // Hapus dari keranjang jika 0
        }

        // Hitung ulang total semua item di keranjang
        totalItems = Object.values(cart).reduce((sum, val) => sum + val, 0);

        // Update Text Qty di Kartu
        const idName = name.replace(/\s+/g, "-");
        const qtyEl = document.getElementById(`qty-${idName}`);
        const cardEl = document.getElementById(`card-${idName}`);

        if (qtyEl) qtyEl.innerText = newQty;

        // Beri highlight warna emas jika kue dipilih
        if (newQty > 0) {
          if (cardEl) cardEl.classList.add("selected");
        } else {
          if (cardEl) cardEl.classList.remove("selected");
        }

        updateUI();
      }

      function updateUI() {
        const limitText = document.getElementById("limitText");
        limitText.innerText = `Terpilih: ${totalItems} / ${maxLimit} Toples`;
        limitText.style.color = totalItems === maxLimit ? "#28a745" : "#ffd700";

        const chipContainer = document.getElementById("chipContainer");
        chipContainer.innerHTML = "";

        // Render ulang list di laci keranjang
        for (let name in cart) {
          chipContainer.innerHTML += `
            <div class="chip">
                <b>${cart[name]}x</b> ${name} 
                <i class="fas fa-times-circle" onclick="updateQty('${name}', -${cart[name]})"></i>
            </div>
          `;
        }

        const drawer = document.getElementById("cartDrawer");
        const btn = document.getElementById("btnOrder");

        if (totalItems > 0) {
          drawer.classList.add("show");
          btn.disabled = false;
          btn.innerText = `Pesan ${totalItems} Toples via WA`;
        } else {
          drawer.classList.remove("show");
          btn.disabled = true;
        }
      }

      function openZoom(src) {
        document.getElementById("zoomImg").src = src;
        document.getElementById("zoomModal").style.display = "flex";
      }

      function closeZoom() {
        document.getElementById("zoomModal").style.display = "none";
      }

      function pesanCookies() {
        let pesan = `Halo Admin, saya mau daftar *PAKET COOKIES*.%0A`;
        pesan += `ðŸ“¦ Kemasan: *Toples (1000ml)*%0A%0A`;
        pesan += `Pilihan Saya (%2B):%0A`;

        let index = 1;
        for (let name in cart) {
          pesan += `${index}. ${name} (${cart[name]} Toples)%0A`;
          index++;
        }

        pesan += `%0AProgram: Tabungan Rp 1.000/hari.%0AMohon dibantu pendaftarannya.`;
        kirimWA("628122261036", pesan);
      }
    </script>
  </body>
</html>
